<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <title>ì—¬í–‰ í›„ê¸° ì‘ì„±</title>

    <!-- ê³µí†µ CSS -->
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <!-- Quill -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

    <style>
        /* =========================
           REVIEWS POST PAGE
        ========================= */
        .reviews-post {
            width: min(1100px, 92%);
            margin: 0 auto;
            padding: 24px 0;
        }

        .reviews-post .page-title {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 20px;
        }

        /* âœ… ì œëª© + ì˜¤ë¥¸ìª½ ë²„íŠ¼ í•œ ì¤„ */
        .reviews-post .reviews-post-title-row{
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px; /* ê¸°ì¡´ page-title margin ì—­í•  */
        }

        /* ê¸°ì¡´ page-title margin ì œê±°(ì¤„ ê²¹ì¹¨ ë°©ì§€) */
        .reviews-post .reviews-post-title-row .page-title{
            margin: 0;
        }

        /* âœ… ê²€ìƒ‰ ë²„íŠ¼(q-btn)ê³¼ ë™ì¼ í†¤ì˜ pill ë²„íŠ¼ */
        .reviews-post .back-btn{
            display: inline-flex;
            align-items: center;
            justify-content: center;

            height: 38px;
            padding: 0 14px;
            border-radius: 999px;

            font-size: 0.86rem;
            font-weight: 800;
            line-height: 1;
            text-decoration: none;
            white-space: nowrap;

            border: 1px solid #d9a26a;
            background: #eea95b; /* ê²€ìƒ‰ ë²„íŠ¼ í†¤ */
            color: #fff;

            box-shadow: 0 2px 0 rgba(0,0,0,0.10);
            transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
        }

        .reviews-post .back-btn:hover{
            transform: translateY(-1px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.12);
            filter: brightness(0.98);
        }

        .reviews-post .back-btn:active{
            transform: translateY(0);
            box-shadow: 0 1px 0 rgba(0,0,0,0.10);
        }


        .write-section {
            margin-bottom: 30px;
        }

        .write-label {
            font-weight: 800;
            margin-bottom: 4px;
        }

        /* ì¡°íšŒ í˜ì´ì§€ì™€ ë™ì¼í•œ hint ìŠ¤íƒ€ì¼ */
        .filter-hint {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .filter-hint.single::before {
            content: "* ";
        }

        .filter-hint.multi::before {
            content: "* ";
        }

        .write-input {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        /* =========================
           íƒœê·¸ UI (reviews.css ë™ì¼ í¬ê¸°)
        ========================= */
        .filter-row {
            display: grid;
            grid-template-columns: 90px 1fr;
            gap: 14px;
            align-items: center;
            margin-bottom: 18px;
        }

        .filter-label {
            font-weight: 800;
            line-height: 1.2;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* ğŸ”¥ ì¡°íšŒ í˜ì´ì§€ì™€ ë™ì¼í•œ chip ì‚¬ì´ì¦ˆ */
        .chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;

            padding: 7px 12px;
            border-radius: 999px;

            font-size: 0.86rem;
            font-weight: 700;
            line-height: 1;

            border: 1px solid #e5e7eb;
            background: #fff;
            color: #374151;

            cursor: pointer;
            transition: 0.12s ease;
            box-shadow: 0 2px 0 rgba(0,0,0,0.07);
        }

        .chip:hover {
            transform: translateY(-1px);
        }

        .chip.active {
            background: #f6c792;
            border-color: #d9a26a;
            color: #3b2f22;
        }

        /* =========================
           ì˜ˆì‚° 4í•­ëª© ì…ë ¥
        ========================= */
        .budget-grid{
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .budget-item{
            display: grid;
            grid-template-columns: 48px 1fr 42px; /* ë¼ë²¨ / ì…ë ¥ / ë‹¨ìœ„ */
            align-items: center;
            gap: 8px;

            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fff;
        }

        .budget-item .b-label{
            font-weight: 800;
            color: #111827;
        }

        .budget-item .b-input{
            height: 40px;
            padding: 0 10px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            font-weight: 800;
        }

        .budget-item .unit{
            font-weight: 800;
            white-space: nowrap;
            color: #374151;
        }

        @media (max-width: 700px){
            .budget-grid{ grid-template-columns: 1fr; }
        }


        .budget-write textarea {
            flex: 1;
            height: 44px;          /* ğŸ”¥ ê³ ì • ë†’ì´ */
            min-height: 44px;      /* ğŸ”¥ ì¤„ì„ */
            max-height: 44px;      /* ğŸ”¥ ëŠ˜ì–´ë‚˜ì§€ ì•Šê²Œ */
            max-width: 300px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            resize: none;          /* ğŸ”¥ í¬ê¸° ì¡°ì ˆ ë¹„í™œì„± */
            line-height: 1.2;
            font-size: 0.95rem;
        }

        .budget-write .unit {
            font-weight: 800;
            white-space: nowrap;
        }

        /* =========================
           Quill
        ========================= */
        #editor {
            height: 320px;
            background: #fff;
        }

        /* =========================
           ì œì¶œ ë²„íŠ¼
        ========================= */
        .submit-btn {
            width: 100%;
            height: 52px;
            border-radius: 14px;
            border: none;
            background: #3b82f6;
            color: #fff;
            font-size: 1.05rem;
            font-weight: 900;
            cursor: pointer;
        }

        /* âœ… ì„ íƒ ìš”ì•½ ë°” */
        .reviews-post .tag-summary-mini{
            margin-top: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #fff;
        }

        .reviews-post .tag-summary-mini .empty{
            color: #94a3b8;
            font-size: 0.95rem;
            font-weight: 700;
        }

        /* âœ… ìš”ì•½ì¹©(í•„í„°ì¹©ê³¼ í†¤ ë§ì¶¤) */
        .reviews-post .tag-summary-mini .chip{
            display: inline-flex;
            align-items: center;
            justify-content: center;

            padding: 6px 10px;
            border-radius: 999px;

            font-size: 0.82rem;
            font-weight: 750;
            line-height: 1;

            background: #ffe1bf;
            border: 1px solid #e6b17a;
            color: #3b2f22;

            box-shadow: 0 2px 0 rgba(0,0,0,0.06);
        }

        /* âœ… ì˜ˆì‚°ì€ í•­ìƒ ì•„ë«ì¤„(ì˜ˆì‹œ ì´ë¯¸ì§€ì²˜ëŸ¼) */
        .reviews-post .tag-summary-mini .chip.budget{
            flex-basis: 100%;
            border-radius: 12px;
            justify-content: flex-start;
            white-space: normal;

            padding: 8px 10px;
            background: #fff7ed;
            border-color: #f0c38d;
            color: #4b3a2a;
        }

        .ql-editor img {
            max-width: 100%;
            height: auto;
        }


    </style>
</head>

<body class="main-page">
<div th:replace="fragments/main-header :: mainHeader"></div>

<main class="container reviews-post">
    <div class="reviews-post-title-row">
        <h1 class="page-title">ì—¬í–‰ í›„ê¸° ì‘ì„±</h1>

        <a class="back-btn" th:href="@{/reviews}" href="/reviews">
            â† ëŒì•„ê°€ê¸°
        </a>
    </div>

    <form id="postForm" method="post" th:action="@{/reviews}">

        <!-- ì œëª© -->
        <section class="write-section">
            <label class="write-label">ì œëª©</label>
            <input type="text" name="title" class="write-input"
                   placeholder="ì—¬í–‰ í›„ê¸°ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”">
        </section>

        <!-- ì˜ˆì‚° -->
        <section class="write-section">
            <label class="write-label">ì‚¬ìš© ê²½ë¹„</label>

            <div class="budget-grid" id="budgetGrid">
                <div class="budget-item">
                    <span class="b-label">í•­ê³µ</span>
                    <input type="text" name="budgetFlight" class="b-input" inputmode="numeric" placeholder="0">
                    <span class="unit">ë§Œ ì›</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">ìˆ™ë°•</span>
                    <input type="text" name="budgetLodging" class="b-input" inputmode="numeric" placeholder="0">
                    <span class="unit">ë§Œ ì›</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">ì‹ë¹„</span>
                    <input type="text" name="budgetFood" class="b-input" inputmode="numeric" placeholder="0">
                    <span class="unit">ë§Œ ì›</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">ê¸°íƒ€</span>
                    <input type="text" name="budgetExtra" class="b-input" inputmode="numeric" placeholder="0">
                    <span class="unit">ë§Œ ì›</span>
                </div>
            </div>

            <!-- ì„œë²„ë¡œ ì´ì•¡ë„ ê°™ì´ ë³´ë‚¼ ê±°ë©´ ì‚¬ìš© -->
            <input type="hidden" name="budgetTotal" id="budgetTotal" value="0">
        </section>


        <!-- íƒœê·¸ ì„ íƒ -->
        <section class="write-section">

            <!-- ì—¬í–‰ ìœ í˜• -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">ì—¬í–‰ ìœ í˜•</div>
                    <div class="filter-hint single">í•œ ê°œë§Œ ì„ íƒ</div>
                </div>
                <div class="filter-chips" data-key="travelType">
                    <button type="button" class="chip" data-value="solo">í˜¼ì</button>
                    <button type="button" class="chip" data-value="couple">ì»¤í”Œ</button>
                    <button type="button" class="chip" data-value="family">ê°€ì¡±</button>
                    <button type="button" class="chip" data-value="friends">ì¹œêµ¬</button>
                </div>
                <input type="hidden" name="travelType">
            </div>

            <!-- í…Œë§ˆ -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">í…Œë§ˆ</div>
                    <div class="filter-hint single">í•œ ê°œë§Œ ì„ íƒ</div>
                </div>
                <div class="filter-chips" data-key="theme">
                    <button type="button" class="chip" data-value="freedom">ììœ </button>
                    <button type="button" class="chip" data-value="healing">íë§</button>
                    <button type="button" class="chip" data-value="food">ë§›ì§‘</button>
                    <button type="button" class="chip" data-value="activity">ì•¡í‹°ë¹„í‹°</button>
                    <button type="button" class="chip" data-value="nature">ìì—°</button>
                </div>
                <input type="hidden" name="theme">
            </div>

            <!-- ê¸°ê°„ -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">ê¸°ê°„</div>
                    <div class="filter-hint single">í•œ ê°œë§Œ ì„ íƒ</div>
                </div>
                <div class="filter-chips" data-key="period">
                    <button type="button" class="chip" data-value="ë‹¹ì¼ì¹˜ê¸°">ë‹¹ì¼</button>
                    <button type="button" class="chip" data-value="1ë°•2ì¼">1ë°•2ì¼</button>
                    <button type="button" class="chip" data-value="2ë°•3ì¼">2ë°•3ì¼</button>
                    <button type="button" class="chip" data-value="3ë°•4ì¼">3ë°•4ì¼</button>
                </div>
                <input type="hidden" name="period">
            </div>

            <!-- ë‚œì´ë„ -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">ë‚œì´ë„</div>
                    <div class="filter-hint single">í•œ ê°œë§Œ ì„ íƒ</div>
                </div>
                <div class="filter-chips" data-key="level">
                    <button type="button" class="chip" data-value="ì´ˆê¸‰">ì´ˆê¸‰</button>
                    <button type="button" class="chip" data-value="ì¤‘ê¸‰">ì¤‘ê¸‰</button>
                    <button type="button" class="chip" data-value="ìƒê¸‰">ìƒê¸‰</button>
                </div>
                <input type="hidden" name="level">
            </div>

            <!-- ì§€ì—­ -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">ì§€ì—­</div>
                    <div class="filter-hint single">ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥</div>
                </div>
                <div class="filter-chips" data-key="region" data-mode="multi">
                    <button type="button" class="chip" data-value="ë„ì¿„">ë„ì¿„</button>
                    <button type="button" class="chip" data-value="ì˜¤ì‚¬ì¹´">ì˜¤ì‚¬ì¹´</button>
                    <button type="button" class="chip" data-value="êµí† ">êµí† </button>
                    <button type="button" class="chip" data-value="í›„ì¿ ì˜¤ì¹´">í›„ì¿ ì˜¤ì¹´</button>
                    <button type="button" class="chip" data-value="ì‚¿í¬ë¡œ">ì‚¿í¬ë¡œ</button>
                </div>

                <!-- ğŸ”¥ ë‹¤ì¤‘ ì„ íƒ hidden inputë“¤ì´ ë“¤ì–´ê°ˆ ìë¦¬ -->
                <div class="region-inputs"></div>
            </div>

            <!-- âœ… ì„ íƒ ì¡°ê±´ ìš”ì•½ UI (ë¯¸ë¦¬ë³´ê¸°) -->
            <div class="tag-summary-mini" id="miniSummary">
                <span class="empty">ì„ íƒëœ ì¡°ê±´ ì—†ìŒ</span>
            </div>

        </section>

        <!-- ë‚´ìš© -->
        <section class="write-section">
            <label class="write-label">ì—¬í–‰ í›„ê¸° ë‚´ìš©</label>
            <div id="editor"></div>
            <input type="hidden" name="content" id="content">
        </section>

        <!-- ì œì¶œ -->
        <section class="write-section">
            <button type="submit" class="submit-btn">
                ì—¬í–‰ í›„ê¸° ë“±ë¡
            </button>
        </section>

    </form>
</main>


<!-- Quill -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
    // =========================
    // CSRF ìœ í‹¸
    // =========================
    function getCsrfHeaders() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        const headerMeta = document.querySelector('meta[name="_csrf_header"]');

        if (!tokenMeta || !headerMeta) return {};

        return {
            [headerMeta.content]: tokenMeta.content
        };
    }

    // =========================
    // Quill + Image Upload
    // =========================
    const toolbarOptions = [
        [{ header: [1, 2, 3, false] }],
        ["bold", "italic", "underline", "strike"],
        [{ color: [] }, { background: [] }],
        [{ list: "ordered" }, { list: "bullet" }],
        [{ align: [] }],
        ["blockquote", "code-block"],
        ["link", "image"],
        ["clean"]
    ];

    const quill = new Quill("#editor", {
        theme: "snow",
        placeholder: "ì—¬í–‰ ì¤‘ ëŠë‚€ ì , íŒ, ì¶”ì²œ ì½”ìŠ¤ë¥¼ ììœ ë¡­ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”",
        modules: {
            toolbar: {
                container: toolbarOptions,
                handlers: {
                    image: imageHandler
                }
            }
        }
    });

    // =========================
    // ì´ë¯¸ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¸ë“¤ëŸ¬
    // =========================
    function imageHandler() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.click();

        input.onchange = async () => {
            const file = input.files && input.files[0];
            if (!file) return;

            // í´ë¼ 1ì°¨ ìš©ëŸ‰ ì œí•œ
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                alert("ì´ë¯¸ì§€ëŠ” ìµœëŒ€ 5MBê¹Œì§€ ì—…ë¡œë“œí•  ìˆ˜ ìˆì–´ìš”.");
                return;
            }

            try {
                const formData = new FormData();
                formData.append("image", file); // ì„œë²„ @RequestParam("image")

                const res = await fetch("/reviews/upload-image", {
                    method: "POST",
                    headers: {
                        ...getCsrfHeaders() // âœ… í•µì‹¬: CSRF í† í° ì¶”ê°€
                    },
                    body: formData
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.error || "ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                const data = await res.json();
                const imageUrl = data.url;

                if (!imageUrl) {
                    alert("ì„œë²„ ì‘ë‹µì— urlì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                // í˜„ì¬ ì»¤ì„œ ìœ„ì¹˜ì— ì´ë¯¸ì§€ ì‚½ì…
                const range = quill.getSelection(true);
                const index = range ? range.index : quill.getLength();

                quill.insertEmbed(index, "image", imageUrl, "user");
                quill.insertText(index + 1, "\n", "user");
                quill.setSelection(index + 2, 0);

            } catch (e) {
                console.error(e);
                alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };
    }

    // =========================
    // submit ì‹œ HTML ì €ì¥
    // =========================
    document.getElementById("postForm").addEventListener("submit", () => {
        document.getElementById("content").value = quill.root.innerHTML;
    });
</script>



<script th:src="@{/js/main.js}" src="/js/main.js"></script>
<script th:src="@{/js/reviews-post.js}" src="/js/reviews-post.js"></script>

</body>
</html>
