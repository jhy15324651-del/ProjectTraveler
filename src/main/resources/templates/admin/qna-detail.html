<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${question.title + ' - Q&A 관리'}">Q&A 상세</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <style>
        .admin-container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .admin-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .back-link { display: inline-flex; align-items: center; gap: 6px; color: #666; text-decoration: none; margin-bottom: 20px; }
        .back-link:hover { color: var(--primary-red); }

        .question-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 30px; }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .question-title { font-size: 20px; font-weight: 700; margin: 0; }
        .question-meta { display: flex; gap: 15px; color: #666; font-size: 14px; margin-bottom: 20px; }
        .question-content { font-size: 15px; line-height: 1.7; color: #333; white-space: pre-wrap; }
        .question-image { margin-top: 15px; max-width: 100%; border-radius: 8px; }

        .badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-answered { background: #e8f5e9; color: #2e7d32; }
        .badge-waiting { background: #fff3e0; color: #e65100; }
        .badge-admin { background: #e3f2fd; color: #1565c0; }
        .badge-user { background: #f5f5f5; color: #666; }

        .answers-section { margin-bottom: 30px; }
        .answers-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .answer-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 22px; margin-bottom: 12px; }
        .answer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .answer-user { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .answer-content { font-size: 14px; line-height: 1.7; color: #333; white-space: pre-wrap; }
        .answer-image { margin-top: 10px; max-width: 100%; border-radius: 8px; }
        .answer-date { font-size: 12px; color: #999; }

        .reply-section { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 25px; }
        .reply-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; }
        .form-group textarea:focus { outline: none; border-color: var(--primary-red); }

        .image-upload-area { display: flex; align-items: center; gap: 12px; }
        .image-upload-area input[type="file"] { font-size: 13px; }
        .image-preview { max-width: 200px; max-height: 150px; border-radius: 8px; display: none; }

        .btn-submit { padding: 12px 30px; background: var(--primary-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-submit:hover { background: #b71c1c; }
        .btn-delete-sm { background: none; border: none; color: #f44336; cursor: pointer; font-size: 13px; }
        .btn-delete-sm:hover { text-decoration: underline; }
    </style>
</head>
<body class="main-page">
<div th:replace="~{fragments/main-header :: mainHeader}"></div>

<div class="admin-container">
    <a href="/admin/course-qna" class="back-link">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Q&A 목록으로
    </a>

    <!-- 질문 카드 -->
    <div class="question-card">
        <div class="question-header">
            <h1 class="question-title" th:text="${question.title}">질문 제목</h1>
            <span class="badge" th:classappend="${question.answered ? 'badge-answered' : 'badge-waiting'}"
                  th:text="${question.answered ? '답변완료' : '대기중'}">상태</span>
        </div>
        <div class="question-meta">
            <span th:text="${question.user.fullName != null ? question.user.fullName : question.user.username}">작성자</span>
            <span th:text="${#temporals.format(question.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-01</span>
            <span th:text="'강좌: ' + ${question.course.title}">강좌명</span>
        </div>
        <div class="question-content" th:text="${question.content}">질문 내용</div>
        <img th:if="${question.imageUrl != null}" th:src="${question.imageUrl}" class="question-image" alt="첨부 이미지">
    </div>

    <!-- 답변 목록 -->
    <div class="answers-section" th:if="${!#lists.isEmpty(question.answers)}">
        <h2 class="answers-title" th:text="'답변 (' + ${#lists.size(question.answers)} + '개)'">답변</h2>
        <div th:each="answer : ${question.answers}" class="answer-card">
            <div class="answer-header">
                <div class="answer-user">
                    <span th:text="${answer.user.fullName != null ? answer.user.fullName : answer.user.username}">답변자</span>
                    <span class="badge" th:classappend="${answer.user.role.name() == 'ADMIN' ? 'badge-admin' : 'badge-user'}"
                          th:text="${answer.user.role.name() == 'ADMIN' ? '관리자' : '수강생'}">역할</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="answer-date" th:text="${#temporals.format(answer.createdAt, 'yyyy-MM-dd HH:mm')}">2026-01-01</span>
                    <button class="btn-delete-sm" th:data-id="${answer.id}" onclick="deleteAnswer(this)">삭제</button>
                </div>
            </div>
            <div class="answer-content" th:text="${answer.content}">답변 내용</div>
            <img th:if="${answer.imageUrl != null}" th:src="${answer.imageUrl}" class="answer-image" alt="첨부 이미지">
        </div>
    </div>

    <!-- 답변 작성 -->
    <div class="reply-section">
        <h2 class="reply-title">답변 작성</h2>
        <form id="answerForm">
            <div class="form-group">
                <label for="answerContent">답변 내용 *</label>
                <textarea id="answerContent" rows="5" required placeholder="답변을 입력하세요..."></textarea>
            </div>
            <div class="form-group">
                <label>이미지 첨부 (선택)</label>
                <div class="image-upload-area">
                    <input type="file" id="answerImage" accept="image/*" onchange="previewImage(this)">
                    <img id="imagePreview" class="image-preview" alt="미리보기">
                </div>
            </div>
            <button type="submit" class="btn-submit" id="submitBtn">답변 등록</button>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const questionId = /*[[${question.id}]]*/ 0;
    let uploadedImageUrl = null;

    function previewImage(input) {
        const preview = document.getElementById('imagePreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.style.display = 'none';
        }
    }

    document.getElementById('answerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const content = document.getElementById('answerContent').value.trim();
        if (!content) { alert('답변 내용을 입력해주세요.'); return; }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = '등록 중...';

        try {
            // 이미지 업로드
            const imageFile = document.getElementById('answerImage').files[0];
            if (imageFile) {
                const formData = new FormData();
                formData.append('file', imageFile);
                const imgRes = await fetch('/admin/course-qna/api/upload-image', { method: 'POST', body: formData });
                const imgResult = await imgRes.json();
                if (imgResult.success) {
                    uploadedImageUrl = imgResult.data.imageUrl;
                }
            }

            const res = await fetch(`/admin/course-qna/api/${questionId}/answer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: content, imageUrl: uploadedImageUrl })
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || '답변 등록에 실패했습니다.');
            }
        } catch (error) {
            alert('서버 오류가 발생했습니다.');
        } finally {
            btn.disabled = false;
            btn.textContent = '답변 등록';
        }
    });

    async function deleteAnswer(button) {
        if (!confirm('정말 이 답변을 삭제하시겠습니까?')) return;
        const id = button.dataset.id;
        try {
            const res = await fetch(`/admin/course-qna/api/answer/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || '삭제에 실패했습니다.');
            }
        } catch (error) {
            alert('서버 오류가 발생했습니다.');
        }
    }
</script>
</body>
</html>
