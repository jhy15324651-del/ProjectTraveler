<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강좌 관리 - 관리자</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <style>
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .admin-title { font-size: 24px; font-weight: 700; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-table th, .admin-table td { padding: 16px; text-align: left; border-bottom: 1px solid #eee; }
        .admin-table th { background: #f8f9fa; font-weight: 600; color: #333; }
        .admin-table tr:last-child td { border-bottom: none; }
        .btn-new { background: var(--primary-red); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; }
        .btn-edit { background: #2196f3; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 13px; }
        .btn-view { background: #4caf50; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 13px; margin-right: 8px; }
        .btn-delete { background: #f44336; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-left: 8px; }
        .btn-delete:hover { background: #d32f2f; }

        /* 삭제 모달 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; color: #f44336; }
        .modal-desc { color: #666; margin-bottom: 20px; }
        .modal-course-info { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .modal-course-info strong { display: block; margin-bottom: 5px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; min-height: 100px; }
        .form-group textarea:focus { outline: none; border-color: var(--primary-red); }
        .modal-actions { display: flex; gap: 10px; }
        .btn-confirm-delete { flex: 1; padding: 12px; background: #f44336; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-confirm-delete:hover { background: #d32f2f; }
        .btn-cancel { flex: 1; padding: 12px; background: #f5f5f5; color: #333; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-cancel:hover { background: #e0e0e0; }
        .admin-nav { margin-bottom: 30px; display: flex; gap: 15px; }
        .admin-nav a { padding: 10px 20px; background: #f5f5f5; border-radius: 8px; text-decoration: none; color: #333; }
        .admin-nav a.active { background: var(--primary-red); color: white; }
        .course-thumb { width: 80px; height: 50px; object-fit: cover; border-radius: 6px; background-size: cover; background-position: center; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-self { background: #e8f5e9; color: #2e7d32; }
        .badge-approval { background: #fff3e0; color: #e65100; }
        .badge-assign { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body class="main-page">
<div th:replace="fragments/main-header :: mainHeader"></div>

<div class="admin-container">
    <div class="admin-title">
        <span>강좌 관리</span>
        <a th:href="@{/admin/courses/new}" href="/admin/courses/new" class="btn-new">+ 새 강좌 등록</a>
    </div>

    <div class="admin-nav">
        <a th:href="@{/admin/courses}" href="/admin/courses" class="active">강좌 관리</a>
        <a th:href="@{/admin/enrollments/requests}" href="/admin/enrollments/requests">수강 승인</a>
        <a th:href="@{/admin/enrollments/assign}" href="/admin/enrollments/assign">강좌 배정</a>
    </div>

    <table class="admin-table">
        <thead>
            <tr>
                <th style="width: 100px;">썸네일</th>
                <th>강좌명</th>
                <th>카테고리</th>
                <th>레벨</th>
                <th>레슨 수</th>
                <th>수강 정책</th>
                <th>액션</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="c : ${courses}">
                <td>
                    <div class="course-thumb" th:style="'background-image: url(' + ${c.thumbnailUrl != null ? c.thumbnailUrl : 'https://via.placeholder.com/80x50'} + ')'"></div>
                </td>
                <td><strong th:text="${c.title}">강좌명</strong></td>
                <td th:text="${c.categoryDisplayName}">카테고리</td>
                <td th:text="${c.levelDisplayName}">레벨</td>
                <td th:text="${c.totalLessonCount + '개'}">0개</td>
                <td>
                    <span class="badge"
                          th:classappend="${c.enrollPolicy.name() == 'SELF' ? 'badge-self' : (c.enrollPolicy.name() == 'APPROVAL' ? 'badge-approval' : 'badge-assign')}"
                          th:text="${c.enrollPolicy.name() == 'SELF' ? '바로 수강' : (c.enrollPolicy.name() == 'APPROVAL' ? '승인 필요' : '배정만')}">
                        정책
                    </span>
                </td>
                <td>
                    <a th:href="@{/admin/courses/{id}(id=${c.id})}" class="btn-view">상세</a>
                    <a th:href="@{/admin/quiz/course/{id}(id=${c.id})}" class="btn-edit" style="background:#ff9800;">퀴즈</a>
                    <a th:href="@{/admin/courses/{id}/edit(id=${c.id})}" class="btn-edit">수정</a>
                    <button class="btn-delete"
                            th:data-id="${c.id}"
                            th:data-title="${c.title}"
                            onclick="openDeleteModal(this)">삭제</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 삭제 확인 모달 -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h3 class="modal-title">강좌 삭제</h3>
        <p class="modal-desc">이 작업은 취소할 수 없습니다. 삭제 전 신중히 확인해주세요.</p>

        <div class="modal-course-info">
            <strong id="deleteCourseTitle">강좌명</strong>
            <span>위 강좌를 삭제합니다.</span>
        </div>

        <form id="deleteForm">
            <input type="hidden" id="deleteCourseId" value="">

            <div class="form-group">
                <label for="deleteReason">삭제 이유 *</label>
                <textarea id="deleteReason" required placeholder="예: 강좌 내용 리뉴얼 예정, 잘못 등록된 강좌, 운영 종료 등"></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">취소</button>
                <button type="submit" class="btn-confirm-delete" id="confirmDeleteBtn">삭제</button>
            </div>
        </form>
    </div>
</div>

<script>
    let deleteTargetId = null;

    function openDeleteModal(button) {
        deleteTargetId = button.dataset.id;
        const title = button.dataset.title;

        document.getElementById('deleteCourseId').value = deleteTargetId;
        document.getElementById('deleteCourseTitle').textContent = title;
        document.getElementById('deleteReason').value = '';
        document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
        deleteTargetId = null;
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
    });

    // 삭제 폼 제출
    document.getElementById('deleteForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const reason = document.getElementById('deleteReason').value.trim();

        if (!reason) {
            alert('삭제 이유를 입력해주세요.');
            return;
        }

        if (!confirm('정말 이 강좌를 삭제하시겠습니까?\n\n삭제된 강좌는 복구할 수 없습니다.')) {
            return;
        }

        const btn = document.getElementById('confirmDeleteBtn');
        btn.disabled = true;
        btn.textContent = '삭제 중...';

        try {
            const response = await fetch(`/admin/courses/api/${deleteTargetId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason })
            });

            const result = await response.json();

            if (result.success) {
                alert('강좌가 삭제되었습니다.');
                location.reload();
            } else {
                alert(result.message || '삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('서버 오류가 발생했습니다.');
        } finally {
            btn.disabled = false;
            btn.textContent = '삭제';
        }
    });
</script>
</body>
</html>
