<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${course.title + ' - 일본 여행 LMS'}" >강좌 상세 - 일본 여행 LMS</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <link rel="stylesheet" th:href="@{/css/learn.css}" href="/css/learn.css">
</head>
<body class="main-page">

<!-- 헤더 -->
<div th:replace="fragments/main-header :: mainHeader"></div>

    <!-- 강좌 상세 헤더 -->
    <section class="course-hero">
        <div class="course-hero-inner">
            <a href="/learning" class="learn-back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                강의 목록으로
            </a>
            <div class="course-hero-content">
                <div class="course-hero-info">
                    <span class="course-category-badge" th:text="${course.categoryDisplayName}">일본어</span>
                    <h1 class="course-title" th:text="${course.title}">강좌명</h1>
                    <p class="course-description" th:text="${course.shortDesc}">강좌 설명</p>

                    <!-- 강좌 요약 정보 -->
                    <div class="course-meta-summary">
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                            </svg>
                            <span th:text="${course.levelDisplayName + ' 레벨'}">입문 레벨</span>
                        </div>
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span th:text="${course.totalUnitCount + '개 유닛 / ' + course.totalLessonCount + '개 레슨'}">4개 유닛 / 12개 레슨</span>
                        </div>
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span th:text="${course.formattedDuration}">총 3시간</span>
                        </div>
                    </div>

                    <!-- 학습 시작/이어하기 버튼 -->
                    <div class="course-action-buttons">
                        <!-- 수강 가능한 경우 -->
                        <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.accessible}">
                            <a th:if="${course.continueLesson != null}"
                               th:href="@{/lesson(courseId=${course.id}, lessonId=${course.continueLesson.id})}"
                               class="btn-course-start" data-action="continue">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                이어서 학습하기
                            </a>
                            <a th:unless="${course.continueLesson != null}"
                               th:href="@{/lesson(courseId=${course.id})}"
                               class="btn-course-start" data-action="start">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                학습 시작하기
                            </a>
                        </th:block>

                        <!-- 수강 신청 필요한 경우 -->
                        <th:block th:if="${course.enrollmentInfo == null or !course.enrollmentInfo.accessible}">
                            <!-- 승인 대기 중 -->
                            <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.status == 'REQUESTED'}">
                                <button class="btn-course-secondary" disabled>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    승인 대기 중
                                </button>
                                <span style="margin-left: 10px; color: #666; font-size: 14px;">
                                    관리자 승인 후 학습 가능합니다
                                </span>
                            </th:block>
                            <!-- 수강 신청 가능 (미신청 또는 거절됨) -->
                            <th:block th:if="${course.enrollmentInfo.status == null or course.enrollmentInfo.status == 'REJECTED'}">
                                <button class="btn-course-start" onclick="requestEnrollment()" id="enrollBtn"
                                        th:data-policy="${course.enrollmentInfo.enrollPolicy}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <line x1="19" y1="8" x2="19" y2="14"/>
                                        <line x1="22" y1="11" x2="16" y2="11"/>
                                    </svg>
                                    <th:block th:if="${course.enrollmentInfo.enrollPolicy == 'SELF'}">바로 수강하기</th:block>
                                    <th:block th:if="${course.enrollmentInfo.enrollPolicy != 'SELF'}">수강 신청</th:block>
                                </button>
                                <span th:if="${course.enrollmentInfo.enrollPolicy == 'APPROVAL'}"
                                      style="margin-left: 10px; color: #666; font-size: 14px;">
                                    (관리자 승인 필요)
                                </span>
                                <span th:if="${course.enrollmentInfo.enrollPolicy == 'SELF'}"
                                      style="margin-left: 10px; color: #4caf50; font-size: 14px;">
                                    (바로 학습 가능)
                                </span>
                            </th:block>
                        </th:block>
                    </div>

                    <!-- 진도율 표시 (수강 중인 경우만) -->
                    <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.accessible and course.progressInfo != null}">
                        <div class="course-progress-section">
                            <div class="course-progress-header">
                                <span>진도율</span>
                                <span class="course-progress-percent" th:text="${course.progressInfo.progressPercent + '%'}">0%</span>
                            </div>
                            <div class="course-progress-bar">
                                <div class="course-progress-fill" th:style="'width: ' + ${course.progressInfo.progressPercent} + '%;'"></div>
                            </div>
                            <p class="course-progress-text"
                               th:text="${course.progressInfo.totalLessonCount + '개 레슨 중 ' + course.progressInfo.completedLessonCount + '개 완료'}">
                                12개 레슨 중 5개 완료
                            </p>
                        </div>
                    </th:block>
                </div>

                <!-- 썸네일 -->
                <div class="course-hero-thumbnail">
                    <div class="course-thumbnail-image"
                         th:style="'background-image: url(' + ${course.thumbnailUrl != null ? course.thumbnailUrl : 'https://via.placeholder.com/800x450'} + ');'"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 탭 네비게이션 -->
    <section class="course-tabs-section">
        <div class="course-tabs-container">
            <div class="course-tabs">
                <button class="course-tab is-active" data-tab="curriculum">커리큘럼</button>
                <button class="course-tab" data-tab="intro">소개</button>
                <button class="course-tab" data-tab="resources">자료실</button>
                <button class="course-tab" data-tab="qna">Q&A</button>
            </div>
        </div>
    </section>

    <!-- 탭 컨텐츠 -->
    <section class="course-content-section">
        <div class="course-content-container">

            <!-- 커리큘럼 탭 (동적) -->
            <div class="course-tab-content is-active" data-tab-content="curriculum">
                <div class="course-curriculum">
                    <!-- 유닛 반복 -->
                    <th:block th:each="unit, unitStat : ${course.units}">
                        <div class="course-unit" th:data-unit-id="${unit.id}">
                            <div class="course-unit-header">
                                <div class="course-unit-info">
                                    <span class="course-unit-number" th:text="'Unit ' + ${unitStat.count}">Unit 1</span>
                                    <h3 class="course-unit-title" th:text="${unit.title}">유닛 제목</h3>
                                    <span class="course-unit-meta"
                                          th:text="${unit.lessonCount + '개 레슨 · ' + unit.formattedDuration}">3개 레슨 · 약 45분</span>
                                </div>
                                <div class="course-unit-status">
                                    <span class="course-unit-progress"
                                          th:classappend="${unit.status == '미시작' ? 'is-locked' : ''}"
                                          th:text="${unit.status}">완료</span>
                                    <svg class="course-unit-toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- 레슨 리스트 -->
                            <div class="course-unit-lessons" th:classappend="${unitStat.first or unit.status != '미시작' ? 'is-open' : ''}">
                                <th:block th:each="lesson : ${unit.lessons}">
                                    <a href="#" class="course-lesson-item"
                                       th:classappend="${lesson.status == '완료' ? 'is-done' : (lesson.status == '진행중' ? 'is-current' : '')}"
                                       th:data-lesson-id="${lesson.id}"
                                       th:onclick="|selectLesson(${course.id}, ${lesson.id})|">
                                        <div class="course-lesson-status">
                                            <!-- 완료 아이콘 -->
                                            <svg th:if="${lesson.status == '완료'}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22 4 12 14.01 9 11.01"/>
                                            </svg>
                                            <!-- 진행중 아이콘 -->
                                            <svg th:if="${lesson.status == '진행중'}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="5 3 19 12 5 21 5 3"/>
                                            </svg>
                                            <!-- 미시작 번호 -->
                                            <span th:if="${lesson.status == '미시작'}" class="course-lesson-number-circle" th:text="${lesson.sortOrder}">1</span>
                                        </div>
                                        <div class="course-lesson-info">
                                            <span class="course-lesson-number" th:text="${lesson.sortOrder + '강'}">1강</span>
                                            <span class="course-lesson-title" th:text="${lesson.title}">레슨 제목</span>
                                            <span th:if="${lesson.status == '진행중'}" class="course-lesson-badge">학습중</span>
                                        </div>
                                        <span class="course-lesson-duration" th:text="${lesson.formattedDuration}">15분</span>
                                    </a>
                                </th:block>
                            </div>
                        </div>
                    </th:block>

                    <!-- 유닛이 없는 경우 -->
                    <th:block th:if="${#lists.isEmpty(course.units)}">
                        <p style="text-align: center; color: #666; padding: 40px;">아직 등록된 커리큘럼이 없습니다.</p>
                    </th:block>
                </div>

                <!-- 퀴즈 상태 카드 (서버 렌더링 - 여러 퀴즈 반복) -->
                <th:block th:if="${quizzes != null and !quizzes.isEmpty()}">
                    <th:block th:each="quiz : ${quizzes}">
                        <div class="quiz-status-card" th:data-quiz-id="${quiz.id}"
                             style="margin-top: 20px; background: white; border-radius: 12px; padding: 20px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #f5f5f5;">&#x1F4DD;</div>
                                    <div>
                                        <div style="font-weight: 600; font-size: 15px;" th:text="${quiz.title}">퀴즈</div>
                                        <div style="font-size: 13px; color: #666; margin-top: 2px;"
                                             th:text="${quiz.totalQuestions + '문제'}">문제 수</div>
                                    </div>
                                </div>
                                <div class="quiz-action-area" th:data-quiz-id="${quiz.id}">
                                    <!-- JS에서 퀴즈별 상태를 로드하여 버튼 동적 생성 -->
                                </div>
                            </div>
                        </div>
                    </th:block>
                </th:block>

                <!-- 퀴즈가 없는 경우 대비 (JS fallback) -->
                <div id="quizStatusCard" style="display: none; margin-top: 20px; background: white; border-radius: 12px; padding: 20px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="quizStatusIcon" style="width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #f5f5f5;"></div>
                            <div>
                                <div id="quizStatusTitle" style="font-weight: 600; font-size: 15px;"></div>
                                <div id="quizStatusMessage" style="font-size: 13px; color: #666; margin-top: 2px;"></div>
                            </div>
                        </div>
                        <div id="quizStatusAction"></div>
                    </div>
                </div>
            </div>

            <!-- 소개 탭 -->
            <div class="course-tab-content" data-tab-content="intro">
                <div class="course-intro-content">
                    <h3>강좌 소개</h3>
                    <p th:utext="${course.fullDesc != null ? course.fullDesc : course.shortDesc}">강좌 설명</p>
                </div>
            </div>

            <!-- 자료실 탭 -->
            <div class="course-tab-content" data-tab-content="resources">
                <div class="course-resources-content" id="resourcesContainer">
                    <p class="course-empty-message" id="resourcesLoading">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        자료를 불러오는 중...
                    </p>
                </div>
            </div>

            <!-- Q&A 탭 -->
            <div class="course-tab-content" data-tab-content="qna">
                <div class="course-qna-content" id="qnaContainer">
                    <!-- 질문 작성 폼 -->
                    <div id="qnaWriteForm" style="background: white; border-radius: 12px; padding: 22px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 15px 0;">질문하기</h3>
                        <input type="text" id="qnaTitle" placeholder="질문 제목을 입력하세요"
                               style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px; box-sizing: border-box;">
                        <textarea id="qnaContent" rows="4" placeholder="질문 내용을 입력하세요..."
                                  style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; margin-bottom: 10px; box-sizing: border-box; resize: vertical;"></textarea>
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label for="qnaImage" style="cursor: pointer; display: flex; align-items: center; gap: 5px; color: #666; font-size: 13px;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21 15 16 10 5 21"/>
                                    </svg>
                                    이미지 첨부
                                </label>
                                <input type="file" id="qnaImage" accept="image/*" style="display: none;" onchange="onQnaImageSelect(this)">
                                <span id="qnaImageName" style="font-size: 12px; color: #999;"></span>
                            </div>
                            <button onclick="submitQuestion()" id="qnaSubmitBtn"
                                    style="padding: 10px 24px; background: var(--primary-red); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                                질문 등록
                            </button>
                        </div>
                    </div>
                    <!-- 질문 목록 -->
                    <div id="qnaList">
                        <p class="course-empty-message" id="qnaLoading">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            질문을 불러오는 중...
                        </p>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- 강좌 ID 저장 -->
    <input type="hidden" id="courseId" th:value="${course.id}">

    <script th:src="@{/js/main.js}" src="/js/main.js"></script>
    <script th:src="@{/js/course-detail.js}" src="/js/course-detail.js"></script>
    <script th:inline="javascript">
        const courseId = /*[[${course.id}]]*/ 0;

        // 수강 신청
        async function requestEnrollment() {
            const btn = document.getElementById('enrollBtn');
            btn.disabled = true;
            btn.textContent = '처리 중...';

            try {
                const response = await fetch('/api/enrollments/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ courseId: courseId })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                    btn.disabled = false;
                    btn.textContent = '수강 신청';
                }
            } catch (error) {
                alert('오류가 발생했습니다.');
                btn.disabled = false;
                btn.textContent = '수강 신청';
            }
        }

        // 퀴즈별 상태 로드 (여러 퀴즈 카드 각각에 대해)
        async function loadQuizStatuses() {
            const quizCards = document.querySelectorAll('.quiz-status-card');
            if (quizCards.length === 0) {
                // 서버 렌더링 퀴즈가 없으면 기존 단일 카드 fallback
                loadQuizStatusLegacy();
                return;
            }

            for (const card of quizCards) {
                const quizId = card.getAttribute('data-quiz-id');
                try {
                    const res = await fetch(`/api/quiz/${quizId}/can-attempt`);
                    const data = await res.json();

                    // 퀴즈별 상세 상태도 가져오기
                    const statusRes = await fetch(`/api/quiz/status/${courseId}`);
                    const statusData = await statusRes.json();

                    const actionArea = card.querySelector('.quiz-action-area');
                    const iconEl = card.querySelector('div[style*="border-radius: 50%"]');

                    // 개별 퀴즈 상태를 /api/quiz/{quizId}/can-attempt + history로 판단
                    const histRes = await fetch(`/api/quiz/${quizId}/history`);
                    const histData = await histRes.json();

                    // 합격 여부 확인
                    const passedAttempt = histData.success && histData.data ?
                        histData.data.find(a => a.passed) : null;

                    if (passedAttempt) {
                        iconEl.textContent = '\u2713';
                        iconEl.style.background = '#e8f5e9';
                        iconEl.style.color = '#2e7d32';
                        card.querySelector('div[style*="font-size: 13px"]').textContent = '최고 점수: ' + passedAttempt.scorePercent + '점';
                        actionArea.innerHTML = '<span style="padding: 8px 16px; background: #e8f5e9; color: #2e7d32; border-radius: 20px; font-size: 13px; font-weight: 600;">합격</span>';
                    } else if (data.success && data.data && data.data.canAttempt) {
                        actionArea.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">퀴즈 응시</a>`;
                    } else {
                        // 응시 불가 - 상태 메시지 표시
                        const attempts = histData.success && histData.data ? histData.data.length : 0;
                        if (attempts >= 2) {
                            iconEl.textContent = '\uD83D\uDCDA';
                            iconEl.style.background = '#fff3e0';
                            card.querySelector('div[style*="font-size: 13px"]').textContent = '재수강이 필요합니다.';
                            actionArea.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${quizId}" style="padding: 10px 24px; background: #ff9800; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">재수강</a>`;
                        } else if (attempts === 1) {
                            iconEl.style.background = '#fff3e0';
                            card.querySelector('div[style*="font-size: 13px"]').textContent = '오답 확인 후 2차 시험에 응시하세요.';
                            actionArea.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">퀴즈 응시</a>`;
                        } else {
                            actionArea.innerHTML = '<span style="padding: 8px 16px; background: #f5f5f5; color: #666; border-radius: 20px; font-size: 13px;">응시 불가</span>';
                        }
                    }
                } catch (e) {
                    console.error('Quiz status load error for quizId=' + quizId, e);
                }
            }
        }

        // 기존 단일 퀴즈 카드 fallback
        async function loadQuizStatusLegacy() {
            try {
                const res = await fetch(`/api/quiz/status/${courseId}`);
                const data = await res.json();
                if (!data.success || !data.data) return;

                const status = data.data;
                const card = document.getElementById('quizStatusCard');
                const icon = document.getElementById('quizStatusIcon');
                const title = document.getElementById('quizStatusTitle');
                const msg = document.getElementById('quizStatusMessage');
                const action = document.getElementById('quizStatusAction');

                card.style.display = 'block';

                if (status.quizStatusCode === 'PASSED') {
                    icon.textContent = '\u2713';
                    icon.style.background = '#e8f5e9';
                    icon.style.color = '#2e7d32';
                    title.textContent = '퀴즈 합격 완료';
                    msg.textContent = '최고 점수: ' + status.bestScore + '점';
                    action.innerHTML = '<span style="padding: 8px 16px; background: #e8f5e9; color: #2e7d32; border-radius: 20px; font-size: 13px; font-weight: 600;">합격</span>';
                } else if (status.canAttempt) {
                    icon.textContent = '\uD83D\uDCDD';
                    title.textContent = status.title || '퀴즈';
                    msg.textContent = status.message || '퀴즈에 응시할 수 있습니다.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">퀴즈 응시</a>`;
                } else if (status.quizStatusCode === 'RETAKE_REQUIRED') {
                    icon.textContent = '\uD83D\uDCDA';
                    icon.style.background = '#fff3e0';
                    title.textContent = '재수강 필요';
                    msg.textContent = status.message || '강의를 다시 수강한 후 퀴즈에 응시해주세요.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: #ff9800; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">재수강</a>`;
                } else if (status.quizStatusCode === 'RETRY_ALLOWED') {
                    icon.textContent = '\uD83D\uDCDD';
                    icon.style.background = '#fff3e0';
                    title.textContent = '2차 시험 응시 가능';
                    msg.textContent = '오답 확인 후 2차 시험에 응시하세요.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">퀴즈 응시</a>`;
                } else {
                    icon.textContent = '\uD83D\uDCDD';
                    title.textContent = status.title || '퀴즈';
                    msg.textContent = status.message || '';
                }
            } catch (e) {
                console.error('Quiz status load error:', e);
            }
        }

        // 수강 가능한 경우 퀴즈 상태 로드
        const isAccessible = /*[[${course.enrollmentInfo != null and course.enrollmentInfo.accessible}]]*/ false;
        if (isAccessible) {
            loadQuizStatuses();
            loadResources();
            loadQna();
        } else {
            // 비수강자에게 안내 메시지 표시
            document.getElementById('resourcesLoading').innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                수강 신청 후 자료를 확인할 수 있습니다.`;
            document.getElementById('qnaWriteForm').style.display = 'none';
            document.getElementById('qnaLoading').innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                수강 신청 후 Q&A를 이용할 수 있습니다.`;
        }

        // 자료실 로드
        async function loadResources() {
            try {
                const res = await fetch(`/api/course-resources/${courseId}`);
                const data = await res.json();
                const container = document.getElementById('resourcesContainer');

                if (!data.success || !data.data || data.data.length === 0) {
                    container.innerHTML = `<p class="course-empty-message">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        등록된 학습 자료가 없습니다.</p>`;
                    return;
                }

                let html = '';
                data.data.forEach(group => {
                    html += `<div style="margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0 0 12px 0; padding: 10px 15px; background: #f8f9fa; border-radius: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            ${group.unitName}
                        </h3>`;
                    group.resources.forEach(r => {
                        const sizeStr = r.fileSize > 1048576 ? (r.fileSize / 1048576).toFixed(1) + 'MB' : Math.round(r.fileSize / 1024) + 'KB';
                        html += `<a href="/api/course-resources/download/${r.id}" style="display: flex; align-items: center; padding: 14px 18px; background: white; border-radius: 10px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); margin-bottom: 8px; text-decoration: none; color: #333; gap: 12px; transition: box-shadow 0.2s;" onmouseover="this.style.boxShadow='0 3px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 1px 6px rgba(0,0,0,0.08)'">
                            <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1565c0" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 3px;">${r.title}</div>
                                <div style="font-size: 12px; color: #999;">${r.originalFileName} · ${sizeStr} · 다운로드 ${r.downloadCount}회</div>
                            </div>
                        </a>`;
                    });
                    html += `</div>`;
                });
                container.innerHTML = html;
            } catch (e) {
                console.error('Resources load error:', e);
                document.getElementById('resourcesContainer').innerHTML = `<p class="course-empty-message">자료를 불러오지 못했습니다.</p>`;
            }
        }

        // Q&A 로드
        async function loadQna() {
            try {
                const res = await fetch(`/api/course-qna/${courseId}`);
                const data = await res.json();
                const listEl = document.getElementById('qnaList');

                if (!data.success || !data.data || data.data.length === 0) {
                    listEl.innerHTML = `<p class="course-empty-message" style="padding: 30px;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        아직 등록된 질문이 없습니다. 첫 번째 질문을 남겨보세요!</p>`;
                    return;
                }

                let html = '';
                data.data.forEach(q => {
                    const dateStr = q.createdAt ? q.createdAt.substring(0, 10) : '';
                    const badge = q.answered
                        ? '<span style="padding: 2px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 10px; font-size: 11px; font-weight: 600;">답변완료</span>'
                        : '<span style="padding: 2px 8px; background: #fff3e0; color: #e65100; border-radius: 10px; font-size: 11px; font-weight: 600;">대기중</span>';
                    html += `<div style="background: white; border-radius: 10px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); margin-bottom: 10px; overflow: hidden;">
                        <div onclick="toggleQnaDetail(this, ${q.id})" style="display: flex; align-items: center; padding: 15px 18px; cursor: pointer; gap: 12px; transition: background 0.2s;" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background='white'">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${q.title}</div>
                                <div style="font-size: 12px; color: #999;">${q.userName} · ${dateStr}</div>
                            </div>
                            ${badge}
                            <svg class="qna-toggle-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="flex-shrink: 0; transition: transform 0.2s;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="qna-detail-panel" style="display: none; padding: 0 18px 18px 18px; border-top: 1px solid #f0f0f0;"></div>
                    </div>`;
                });
                listEl.innerHTML = html;
            } catch (e) {
                console.error('QnA load error:', e);
                document.getElementById('qnaList').innerHTML = `<p class="course-empty-message">Q&A를 불러오지 못했습니다.</p>`;
            }
        }

        // Q&A 상세 토글 (아코디언)
        async function toggleQnaDetail(headerEl, questionId) {
            const panel = headerEl.nextElementSibling;
            const icon = headerEl.querySelector('.qna-toggle-icon');

            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                return;
            }

            // 로딩
            panel.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            panel.innerHTML = '<p style="color: #999; font-size: 13px; padding: 10px 0;">불러오는 중...</p>';

            try {
                const res = await fetch(`/api/course-qna/question/${questionId}`);
                const data = await res.json();
                if (!data.success || !data.data) {
                    panel.innerHTML = '<p style="color: #f44336;">상세 내용을 불러올 수 없습니다.</p>';
                    return;
                }
                const q = data.data;
                let html = `<div style="padding-top: 15px;">
                    <div style="font-size: 14px; line-height: 1.7; color: #333; white-space: pre-wrap; margin-bottom: 12px;">${q.content}</div>`;
                if (q.imageUrl) {
                    html += `<img src="${q.imageUrl}" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;" alt="첨부 이미지">`;
                }

                if (q.answers && q.answers.length > 0) {
                    html += `<div style="margin-top: 15px;">`;
                    q.answers.forEach(a => {
                        const roleBadge = a.userRole === 'ADMIN'
                            ? '<span style="padding: 1px 6px; background: #e3f2fd; color: #1565c0; border-radius: 8px; font-size: 11px; margin-left: 5px;">관리자</span>'
                            : '';
                        html += `<div style="background: #f8f9fa; border-radius: 8px; padding: 14px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600; font-size: 13px;">${a.userName}${roleBadge}</span>
                                <span style="font-size: 12px; color: #999;">${a.createdAt ? a.createdAt.substring(0, 10) : ''}</span>
                            </div>
                            <div style="font-size: 13px; line-height: 1.6; color: #333; white-space: pre-wrap;">${a.content}</div>`;
                        if (a.imageUrl) {
                            html += `<img src="${a.imageUrl}" style="max-width: 100%; border-radius: 8px; margin-top: 8px;" alt="첨부 이미지">`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<p style="color: #999; font-size: 13px; text-align: center; padding: 10px;">아직 답변이 없습니다.</p>`;
                }
                html += `</div>`;
                panel.innerHTML = html;
            } catch (e) {
                panel.innerHTML = '<p style="color: #f44336;">오류가 발생했습니다.</p>';
            }
        }

        // 이미지 선택
        let qnaSelectedImageUrl = null;
        function onQnaImageSelect(input) {
            const nameEl = document.getElementById('qnaImageName');
            if (input.files && input.files[0]) {
                nameEl.textContent = input.files[0].name;
            } else {
                nameEl.textContent = '';
            }
        }

        // 질문 등록
        async function submitQuestion() {
            const title = document.getElementById('qnaTitle').value.trim();
            const content = document.getElementById('qnaContent').value.trim();
            if (!title || !content) { alert('제목과 내용을 입력해주세요.'); return; }

            const btn = document.getElementById('qnaSubmitBtn');
            btn.disabled = true;
            btn.textContent = '등록 중...';

            try {
                // 이미지 업로드
                let imageUrl = null;
                const imageFile = document.getElementById('qnaImage').files[0];
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    const imgRes = await fetch('/api/course-qna/upload-image', { method: 'POST', body: formData });
                    const imgData = await imgRes.json();
                    if (imgData.success) imageUrl = imgData.data.imageUrl;
                }

                const res = await fetch(`/api/course-qna/${courseId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content, imageUrl })
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('qnaTitle').value = '';
                    document.getElementById('qnaContent').value = '';
                    document.getElementById('qnaImage').value = '';
                    document.getElementById('qnaImageName').textContent = '';
                    loadQna();
                    alert('질문이 등록되었습니다.');
                } else {
                    alert(result.message || '질문 등록에 실패했습니다.');
                }
            } catch (e) {
                alert('오류가 발생했습니다.');
            } finally {
                btn.disabled = false;
                btn.textContent = '질문 등록';
            }
        }

        // 레슨 선택 (영상 재생 페이지로 이동)
        function selectLesson(courseId, lessonId) {
            // 수강 권한이 있는 경우에만 이동
            const isAccessible = /*[[${course.enrollmentInfo != null and course.enrollmentInfo.accessible}]]*/ false;
            if (!isAccessible) {
                alert('수강 신청 후 학습할 수 있습니다.');
                return;
            }
            // 영상 재생 페이지로 이동
            window.location.href = '/lesson?courseId=' + courseId + '&lessonId=' + lessonId;
        }
    </script>
</body>
</html>
