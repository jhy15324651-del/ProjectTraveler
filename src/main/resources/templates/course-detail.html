<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${course.title + ' - ì¼ë³¸ ì—¬í–‰ LMS'}" >ê°•ì¢Œ ìƒì„¸ - ì¼ë³¸ ì—¬í–‰ LMS</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <link rel="stylesheet" th:href="@{/css/learn.css}" href="/css/learn.css">
</head>
<body class="main-page">

<!-- í—¤ë” -->
<div th:replace="fragments/main-header :: mainHeader"></div>

    <!-- ê°•ì¢Œ ìƒì„¸ í—¤ë” -->
    <section class="course-hero">
        <div class="course-hero-inner">
            <a href="/learning" class="learn-back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                ê°•ì˜ ëª©ë¡ìœ¼ë¡œ
            </a>
            <div class="course-hero-content">
                <div class="course-hero-info">
                    <span class="course-category-badge" th:text="${course.categoryDisplayName}">ì¼ë³¸ì–´</span>
                    <h1 class="course-title" th:text="${course.title}">ê°•ì¢Œëª…</h1>
                    <p class="course-description" th:text="${course.shortDesc}">ê°•ì¢Œ ì„¤ëª…</p>

                    <!-- ê°•ì¢Œ ìš”ì•½ ì •ë³´ -->
                    <div class="course-meta-summary">
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                            </svg>
                            <span th:text="${course.levelDisplayName + ' ë ˆë²¨'}">ì…ë¬¸ ë ˆë²¨</span>
                        </div>
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span th:text="${course.totalUnitCount + 'ê°œ ìœ ë‹› / ' + course.totalLessonCount + 'ê°œ ë ˆìŠ¨'}">4ê°œ ìœ ë‹› / 12ê°œ ë ˆìŠ¨</span>
                        </div>
                        <div class="course-meta-item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span th:text="${course.formattedDuration}">ì´ 3ì‹œê°„</span>
                        </div>
                    </div>

                    <!-- í•™ìŠµ ì‹œì‘/ì´ì–´í•˜ê¸° ë²„íŠ¼ -->
                    <div class="course-action-buttons">
                        <!-- ìˆ˜ê°• ê°€ëŠ¥í•œ ê²½ìš° -->
                        <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.accessible}">
                            <a th:if="${course.continueLesson != null}"
                               th:href="@{/lesson(courseId=${course.id}, lessonId=${course.continueLesson.id})}"
                               class="btn-course-start" data-action="continue">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                ì´ì–´ì„œ í•™ìŠµí•˜ê¸°
                            </a>
                            <a th:unless="${course.continueLesson != null}"
                               th:href="@{/lesson(courseId=${course.id})}"
                               class="btn-course-start" data-action="start">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                í•™ìŠµ ì‹œì‘í•˜ê¸°
                            </a>
                        </th:block>

                        <!-- ìˆ˜ê°• ì‹ ì²­ í•„ìš”í•œ ê²½ìš° -->
                        <th:block th:if="${course.enrollmentInfo == null or !course.enrollmentInfo.accessible}">
                            <!-- ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ -->
                            <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.status == 'REQUESTED'}">
                                <button class="btn-course-secondary" disabled>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                                </button>
                                <span style="margin-left: 10px; color: #666; font-size: 14px;">
                                    ê´€ë¦¬ì ìŠ¹ì¸ í›„ í•™ìŠµ ê°€ëŠ¥í•©ë‹ˆë‹¤
                                </span>
                            </th:block>
                            <!-- ìˆ˜ê°• ì‹ ì²­ ê°€ëŠ¥ (ë¯¸ì‹ ì²­ ë˜ëŠ” ê±°ì ˆë¨) -->
                            <th:block th:if="${course.enrollmentInfo.status == null or course.enrollmentInfo.status == 'REJECTED'}">
                                <button class="btn-course-start" onclick="requestEnrollment()" id="enrollBtn"
                                        th:data-policy="${course.enrollmentInfo.enrollPolicy}">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <line x1="19" y1="8" x2="19" y2="14"/>
                                        <line x1="22" y1="11" x2="16" y2="11"/>
                                    </svg>
                                    <th:block th:if="${course.enrollmentInfo.enrollPolicy == 'SELF'}">ë°”ë¡œ ìˆ˜ê°•í•˜ê¸°</th:block>
                                    <th:block th:if="${course.enrollmentInfo.enrollPolicy != 'SELF'}">ìˆ˜ê°• ì‹ ì²­</th:block>
                                </button>
                                <span th:if="${course.enrollmentInfo.enrollPolicy == 'APPROVAL'}"
                                      style="margin-left: 10px; color: #666; font-size: 14px;">
                                    (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)
                                </span>
                                <span th:if="${course.enrollmentInfo.enrollPolicy == 'SELF'}"
                                      style="margin-left: 10px; color: #4caf50; font-size: 14px;">
                                    (ë°”ë¡œ í•™ìŠµ ê°€ëŠ¥)
                                </span>
                            </th:block>
                        </th:block>
                    </div>

                    <!-- ì§„ë„ìœ¨ í‘œì‹œ (ìˆ˜ê°• ì¤‘ì¸ ê²½ìš°ë§Œ) -->
                    <th:block th:if="${course.enrollmentInfo != null and course.enrollmentInfo.accessible and course.progressInfo != null}">
                        <div class="course-progress-section">
                            <div class="course-progress-header">
                                <span>ì§„ë„ìœ¨</span>
                                <span class="course-progress-percent" th:text="${course.progressInfo.progressPercent + '%'}">0%</span>
                            </div>
                            <div class="course-progress-bar">
                                <div class="course-progress-fill" th:style="'width: ' + ${course.progressInfo.progressPercent} + '%;'"></div>
                            </div>
                            <p class="course-progress-text"
                               th:text="${course.progressInfo.totalLessonCount + 'ê°œ ë ˆìŠ¨ ì¤‘ ' + course.progressInfo.completedLessonCount + 'ê°œ ì™„ë£Œ'}">
                                12ê°œ ë ˆìŠ¨ ì¤‘ 5ê°œ ì™„ë£Œ
                            </p>
                        </div>
                    </th:block>
                </div>

                <!-- ì¸ë„¤ì¼ -->
                <div class="course-hero-thumbnail">
                    <div class="course-thumbnail-image"
                         th:style="'background-image: url(' + ${course.thumbnailUrl != null ? course.thumbnailUrl : 'https://via.placeholder.com/800x450'} + ');'"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <section class="course-tabs-section">
        <div class="course-tabs-container">
            <div class="course-tabs">
                <button class="course-tab is-active" data-tab="curriculum">ì»¤ë¦¬í˜ëŸ¼</button>
                <button class="course-tab" data-tab="intro">ì†Œê°œ</button>
                <button class="course-tab" data-tab="resources">ìë£Œì‹¤</button>
                <button class="course-tab" data-tab="qna">Q&A</button>
            </div>
        </div>
    </section>

    <!-- íƒ­ ì»¨í…ì¸  -->
    <section class="course-content-section">
        <div class="course-content-container">

            <!-- ì»¤ë¦¬í˜ëŸ¼ íƒ­ (ë™ì ) -->
            <div class="course-tab-content is-active" data-tab-content="curriculum">
                <div class="course-curriculum">
                    <!-- ìœ ë‹› ë°˜ë³µ -->
                    <th:block th:each="unit, unitStat : ${course.units}">
                        <div class="course-unit" th:data-unit-id="${unit.id}">
                            <div class="course-unit-header">
                                <div class="course-unit-info">
                                    <span class="course-unit-number" th:text="'Unit ' + ${unitStat.count}">Unit 1</span>
                                    <h3 class="course-unit-title" th:text="${unit.title}">ìœ ë‹› ì œëª©</h3>
                                    <span class="course-unit-meta"
                                          th:text="${unit.lessonCount + 'ê°œ ë ˆìŠ¨ Â· ' + unit.formattedDuration}">3ê°œ ë ˆìŠ¨ Â· ì•½ 45ë¶„</span>
                                </div>
                                <div class="course-unit-status">
                                    <span class="course-unit-progress"
                                          th:classappend="${unit.status == 'ë¯¸ì‹œì‘' ? 'is-locked' : ''}"
                                          th:text="${unit.status}">ì™„ë£Œ</span>
                                    <svg class="course-unit-toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="6 9 12 15 18 9"/>
                                    </svg>
                                </div>
                            </div>

                            <!-- ë ˆìŠ¨ ë¦¬ìŠ¤íŠ¸ -->
                            <div class="course-unit-lessons" th:classappend="${unitStat.first or unit.status != 'ë¯¸ì‹œì‘' ? 'is-open' : ''}">
                                <th:block th:each="lesson : ${unit.lessons}">
                                    <a href="#" class="course-lesson-item"
                                       th:classappend="${lesson.status == 'ì™„ë£Œ' ? 'is-done' : (lesson.status == 'ì§„í–‰ì¤‘' ? 'is-current' : '')}"
                                       th:data-lesson-id="${lesson.id}"
                                       th:onclick="|selectLesson(${course.id}, ${lesson.id})|">
                                        <div class="course-lesson-status">
                                            <!-- ì™„ë£Œ ì•„ì´ì½˜ -->
                                            <svg th:if="${lesson.status == 'ì™„ë£Œ'}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22 4 12 14.01 9 11.01"/>
                                            </svg>
                                            <!-- ì§„í–‰ì¤‘ ì•„ì´ì½˜ -->
                                            <svg th:if="${lesson.status == 'ì§„í–‰ì¤‘'}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="5 3 19 12 5 21 5 3"/>
                                            </svg>
                                            <!-- ë¯¸ì‹œì‘ ë²ˆí˜¸ -->
                                            <span th:if="${lesson.status == 'ë¯¸ì‹œì‘'}" class="course-lesson-number-circle" th:text="${lesson.sortOrder}">1</span>
                                        </div>
                                        <div class="course-lesson-info">
                                            <span class="course-lesson-number" th:text="${lesson.sortOrder + 'ê°•'}">1ê°•</span>
                                            <span class="course-lesson-title" th:text="${lesson.title}">ë ˆìŠ¨ ì œëª©</span>
                                            <span th:if="${lesson.status == 'ì§„í–‰ì¤‘'}" class="course-lesson-badge">í•™ìŠµì¤‘</span>
                                        </div>
                                        <span class="course-lesson-duration" th:text="${lesson.formattedDuration}">15ë¶„</span>
                                    </a>
                                </th:block>
                            </div>
                        </div>
                    </th:block>

                    <!-- ìœ ë‹›ì´ ì—†ëŠ” ê²½ìš° -->
                    <th:block th:if="${#lists.isEmpty(course.units)}">
                        <p style="text-align: center; color: #666; padding: 40px;">ì•„ì§ ë“±ë¡ëœ ì»¤ë¦¬í˜ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </th:block>
                </div>

                <!-- í€´ì¦ˆ ìƒíƒœ ì¹´ë“œ -->
                <div id="quizStatusCard" style="display: none; margin-top: 20px; background: white; border-radius: 12px; padding: 20px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div id="quizStatusIcon" style="width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #f5f5f5;"></div>
                            <div>
                                <div id="quizStatusTitle" style="font-weight: 600; font-size: 15px;"></div>
                                <div id="quizStatusMessage" style="font-size: 13px; color: #666; margin-top: 2px;"></div>
                            </div>
                        </div>
                        <div id="quizStatusAction"></div>
                    </div>
                </div>
            </div>

            <!-- ì†Œê°œ íƒ­ -->
            <div class="course-tab-content" data-tab-content="intro">
                <div class="course-intro-content">
                    <h3>ê°•ì¢Œ ì†Œê°œ</h3>
                    <p th:utext="${course.fullDesc != null ? course.fullDesc : course.shortDesc}">ê°•ì¢Œ ì„¤ëª…</p>
                </div>
            </div>

            <!-- ìë£Œì‹¤ íƒ­ -->
            <div class="course-tab-content" data-tab-content="resources">
                <div class="course-resources-content">
                    <p class="course-empty-message">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="12" y1="18" x2="12" y2="12"/>
                            <line x1="9" y1="15" x2="15" y2="15"/>
                        </svg>
                        ìë£Œì‹¤ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- Q&A íƒ­ -->
            <div class="course-tab-content" data-tab-content="qna">
                <div class="course-qna-content">
                    <p class="course-empty-message">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        Q&A ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

        </div>
    </section>

    <!-- ê°•ì¢Œ ID ì €ì¥ -->
    <input type="hidden" id="courseId" th:value="${course.id}">

    <script th:src="@{/js/main.js}" src="/js/main.js"></script>
    <script th:src="@{/js/course-detail.js}" src="/js/course-detail.js"></script>
    <script th:inline="javascript">
        const courseId = /*[[${course.id}]]*/ 0;

        // ìˆ˜ê°• ì‹ ì²­
        async function requestEnrollment() {
            const btn = document.getElementById('enrollBtn');
            btn.disabled = true;
            btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const response = await fetch('/api/enrollments/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ courseId: courseId })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.message);
                    btn.disabled = false;
                    btn.textContent = 'ìˆ˜ê°• ì‹ ì²­';
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.textContent = 'ìˆ˜ê°• ì‹ ì²­';
            }
        }

        // í€´ì¦ˆ ìƒíƒœ ë¡œë“œ
        async function loadQuizStatus() {
            try {
                const res = await fetch(`/api/quiz/status/${courseId}`);
                const data = await res.json();
                if (!data.success || !data.data) return;

                const status = data.data;
                const card = document.getElementById('quizStatusCard');
                const icon = document.getElementById('quizStatusIcon');
                const title = document.getElementById('quizStatusTitle');
                const msg = document.getElementById('quizStatusMessage');
                const action = document.getElementById('quizStatusAction');

                card.style.display = 'block';

                if (status.quizStatusCode === 'PASSED') {
                    icon.textContent = 'âœ“';
                    icon.style.background = '#e8f5e9';
                    icon.style.color = '#2e7d32';
                    title.textContent = 'í€´ì¦ˆ í•©ê²© ì™„ë£Œ';
                    msg.textContent = 'ìµœê³  ì ìˆ˜: ' + status.bestScore + 'ì ';
                    action.innerHTML = '<span style="padding: 8px 16px; background: #e8f5e9; color: #2e7d32; border-radius: 20px; font-size: 13px; font-weight: 600;">í•©ê²©</span>';
                } else if (status.canAttempt) {
                    icon.textContent = 'ğŸ“';
                    title.textContent = status.title || 'í€´ì¦ˆ';
                    msg.textContent = status.message || 'í€´ì¦ˆì— ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">í€´ì¦ˆ ì‘ì‹œ</a>`;
                } else if (status.quizStatusCode === 'RETAKE_REQUIRED') {
                    icon.textContent = 'ğŸ“š';
                    icon.style.background = '#fff3e0';
                    title.textContent = 'ì¬ìˆ˜ê°• í•„ìš”';
                    msg.textContent = status.message || 'ê°•ì˜ë¥¼ ë‹¤ì‹œ ìˆ˜ê°•í•œ í›„ í€´ì¦ˆì— ì‘ì‹œí•´ì£¼ì„¸ìš”.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: #ff9800; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">ì¬ìˆ˜ê°•</a>`;
                } else if (status.quizStatusCode === 'RETRY_ALLOWED') {
                    icon.textContent = 'ğŸ“';
                    icon.style.background = '#fff3e0';
                    title.textContent = '2ì°¨ ì‹œí—˜ ì‘ì‹œ ê°€ëŠ¥';
                    msg.textContent = 'ì˜¤ë‹µ í™•ì¸ í›„ 2ì°¨ ì‹œí—˜ì— ì‘ì‹œí•˜ì„¸ìš”.';
                    action.innerHTML = `<a href="/quiz?courseId=${courseId}&quizId=${status.quizId}" style="padding: 10px 24px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">í€´ì¦ˆ ì‘ì‹œ</a>`;
                } else {
                    icon.textContent = 'ğŸ“';
                    title.textContent = status.title || 'í€´ì¦ˆ';
                    msg.textContent = status.message || '';
                }
            } catch (e) {
                console.error('Quiz status load error:', e);
            }
        }

        // ìˆ˜ê°• ê°€ëŠ¥í•œ ê²½ìš° í€´ì¦ˆ ìƒíƒœ ë¡œë“œ
        const isAccessible = /*[[${course.enrollmentInfo != null and course.enrollmentInfo.accessible}]]*/ false;
        if (isAccessible) {
            loadQuizStatus();
        }

        // ë ˆìŠ¨ ì„ íƒ (ì˜ìƒ ì¬ìƒ í˜ì´ì§€ë¡œ ì´ë™)
        function selectLesson(courseId, lessonId) {
            // ìˆ˜ê°• ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì´ë™
            const isAccessible = /*[[${course.enrollmentInfo != null and course.enrollmentInfo.accessible}]]*/ false;
            if (!isAccessible) {
                alert('ìˆ˜ê°• ì‹ ì²­ í›„ í•™ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            // ì˜ìƒ ì¬ìƒ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = '/lesson?courseId=' + courseId + '&lessonId=' + lessonId;
        }
    </script>
</body>
</html>
