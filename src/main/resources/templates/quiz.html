<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í€´ì¦ˆ - ì¼ë³¸ ì—¬í–‰ LMS</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="/css/style.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .quiz-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .quiz-back { display: inline-flex; align-items: center; gap: 8px; color: #666; text-decoration: none; margin-bottom: 20px; }
        .quiz-back:hover { color: var(--primary-red); }

        /* í€´ì¦ˆ í—¤ë” */
        .quiz-header { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 25px; }
        .quiz-title { font-size: 22px; font-weight: 700; margin: 0 0 8px 0; }
        .quiz-desc { color: #666; margin: 0 0 15px 0; font-size: 14px; }
        .quiz-info-bar { display: flex; gap: 20px; flex-wrap: wrap; }
        .quiz-info-item { display: flex; align-items: center; gap: 6px; font-size: 14px; color: #555; }
        .quiz-info-item svg { flex-shrink: 0; }

        /* íƒ€ì´ë¨¸ */
        .quiz-timer { position: sticky; top: 0; z-index: 100; background: white; border-radius: 12px; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .quiz-timer.warning { background: #fff3e0; }
        .quiz-timer.danger { background: #ffebee; }
        .timer-text { font-size: 18px; font-weight: 700; }
        .timer-text.warning { color: #e65100; }
        .timer-text.danger { color: #c62828; }
        .quiz-progress-text { font-size: 14px; color: #666; }

        /* ë¬¸ì œ ì¹´ë“œ */
        .question-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 16px; }
        .question-number { font-size: 13px; font-weight: 600; color: var(--primary-red); margin-bottom: 8px; }
        .question-text { font-size: 16px; font-weight: 600; margin-bottom: 18px; line-height: 1.6; }
        .option-list { display: flex; flex-direction: column; gap: 10px; }
        .option-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .option-item:hover { border-color: #ccc; background: #fafafa; }
        .option-item.selected { border-color: var(--primary-red); background: #fff5f5; }
        .option-radio { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ccc; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .option-item.selected .option-radio { border-color: var(--primary-red); background: var(--primary-red); }
        .option-item.selected .option-radio::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: white; }
        .option-text { font-size: 15px; line-height: 1.5; }

        /* ë¦¬ë·° ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .option-item.correct { border-color: #4caf50; background: #e8f5e9; }
        .option-item.correct .option-radio { border-color: #4caf50; background: #4caf50; }
        .option-item.wrong { border-color: #f44336; background: #ffebee; }
        .option-item.wrong .option-radio { border-color: #f44336; background: #f44336; }
        .option-item.correct .option-radio::after, .option-item.wrong .option-radio::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: white; }
        .question-result-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 10px; }
        .question-result-badge.correct { background: #e8f5e9; color: #2e7d32; }
        .question-result-badge.wrong { background: #ffebee; color: #c62828; }

        /* ì œì¶œ ë²„íŠ¼ */
        .quiz-submit-area { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; margin-top: 20px; }
        .quiz-submit-btn { padding: 16px 60px; background: var(--primary-red); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
        .quiz-submit-btn:hover { background: #b71c1c; }
        .quiz-submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        .quiz-unanswered-notice { color: #e65100; font-size: 14px; margin-top: 10px; }

        /* ê²°ê³¼ í™”ë©´ */
        .result-container { background: white; border-radius: 16px; padding: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .result-icon { font-size: 64px; margin-bottom: 15px; }
        .result-title { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
        .result-title.pass { color: #2e7d32; }
        .result-title.fail { color: #c62828; }
        .result-score { font-size: 48px; font-weight: 800; margin: 20px 0; }
        .result-score.pass { color: #4caf50; }
        .result-score.fail { color: #f44336; }
        .result-detail { font-size: 16px; color: #666; margin-bottom: 8px; }
        .result-message { font-size: 15px; color: #555; margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 10px; line-height: 1.6; }
        .result-actions { display: flex; gap: 12px; justify-content: center; margin-top: 25px; flex-wrap: wrap; }
        .result-btn { padding: 14px 30px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; border: none; }
        .result-btn-primary { background: var(--primary-red); color: white; }
        .result-btn-primary:hover { background: #b71c1c; }
        .result-btn-secondary { background: #f5f5f5; color: #333; }
        .result-btn-secondary:hover { background: #eee; }
        .result-btn-success { background: #4caf50; color: white; }
        .result-btn-success:hover { background: #43a047; }

        /* ë¡œë”© */
        .quiz-loading { text-align: center; padding: 80px 20px; color: #666; }
        .quiz-loading .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary-red); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ì—ëŸ¬ */
        .quiz-error { text-align: center; padding: 80px 20px; }
        .quiz-error h2 { color: #c62828; margin-bottom: 15px; }
        .quiz-error p { color: #666; margin-bottom: 20px; }
        .quiz-error a { display: inline-block; padding: 12px 30px; background: var(--primary-red); color: white; text-decoration: none; border-radius: 8px; }
    </style>
</head>
<body class="main-page">
<div th:replace="fragments/main-header :: mainHeader"></div>

<div class="quiz-container">
    <a th:href="@{/course-detail(id=${courseId})}" class="quiz-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°
    </a>

    <!-- ë¡œë”© ìƒíƒœ -->
    <div id="loadingView" class="quiz-loading">
        <div class="spinner"></div>
        <p>í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ì—ëŸ¬ ìƒíƒœ -->
    <div id="errorView" class="quiz-error" style="display: none;">
        <h2 id="errorTitle">í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
        <p id="errorMessage"></p>
        <a th:href="@{/course-detail(id=${courseId})}">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <!-- í€´ì¦ˆ ì‘ì‹œ í™”ë©´ -->
    <div id="quizView" style="display: none;">
        <div class="quiz-header">
            <h1 class="quiz-title" id="quizTitle"></h1>
            <p class="quiz-desc" id="quizDesc"></p>
            <div class="quiz-info-bar">
                <div class="quiz-info-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    <span id="quizQuestionCount">0ë¬¸ì œ</span>
                </div>
                <div class="quiz-info-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    </svg>
                    <span id="quizPassingScore">í•©ê²© ê¸°ì¤€: 80ì </span>
                </div>
                <div class="quiz-info-item" id="timeLimitInfo" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span id="quizTimeLimit">ì œí•œì‹œê°„: ì—†ìŒ</span>
                </div>
            </div>
        </div>

        <!-- íƒ€ì´ë¨¸ (ì œí•œì‹œê°„ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
        <div class="quiz-timer" id="timerBar" style="display: none;">
            <span class="timer-text" id="timerText">00:00</span>
            <span class="quiz-progress-text" id="answeredCount">0 / 0 ë‹µë³€</span>
        </div>

        <!-- ë¬¸ì œ ëª©ë¡ -->
        <div id="questionsContainer"></div>

        <!-- ì œì¶œ -->
        <div class="quiz-submit-area">
            <button class="quiz-submit-btn" id="submitBtn" onclick="submitQuiz()">ì œì¶œí•˜ê¸°</button>
            <p class="quiz-unanswered-notice" id="unansweredNotice" style="display: none;"></p>
        </div>
    </div>

    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="resultView" style="display: none;"></div>

    <!-- ì˜¤ë‹µ í™•ì¸ í™”ë©´ -->
    <div id="reviewView" style="display: none;"></div>
</div>

<script th:inline="javascript">
    const courseId = /*[[${courseId}]]*/ 0;
    const quizIdParam = /*[[${quizId}]]*/ null;

    let quizData = null;
    let selectedAnswers = {};  // { questionId: optionId }
    let timerInterval = null;
    let remainingSec = 0;
    let isSubmitting = false;  // ì¤‘ë³µ ì œì¶œ ë°©ì§€ í”Œë˜ê·¸

    // ============ ì´ˆê¸°í™” ============
    async function init() {
        try {
            // quizIdê°€ ì—†ìœ¼ë©´ courseIdë¡œ í€´ì¦ˆ ì¡°íšŒ
            let quizId = quizIdParam;
            if (!quizId) {
                const courseRes = await fetch(`/api/quiz/course/${courseId}`);
                const courseData = await courseRes.json();
                if (!courseData.success || !courseData.data) {
                    showError('í€´ì¦ˆ ì—†ìŒ', courseData.message || 'ì´ ê°•ì¢Œì—ëŠ” í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                quizId = courseData.data.id;
            }

            // í€´ì¦ˆ ë°ì´í„° ë¡œë“œ
            const res = await fetch(`/api/quiz/${quizId}`);
            const data = await res.json();

            if (res.status === 403) {
                // ì‘ì‹œ ë¶ˆê°€ ìƒíƒœ ì²˜ë¦¬
                const statusData = data.data && data.data.quizStatus;
                if (statusData) {
                    handleQuizStatus(statusData);
                } else {
                    showError('ì‘ì‹œ ë¶ˆê°€', data.message || 'í€´ì¦ˆì— ì‘ì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                return;
            }

            if (!data.success || !data.data) {
                showError('ì˜¤ë¥˜', data.message || 'í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            quizData = data.data;
            renderQuiz();
        } catch (e) {
            console.error('Quiz load error:', e);
            showError('ì˜¤ë¥˜', 'í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ============ ìƒíƒœë³„ ì²˜ë¦¬ ============
    function handleQuizStatus(status) {
        if (status.quizStatusCode === 'PASSED') {
            showResult({
                passed: true,
                scorePercent: status.bestScore,
                passingScore: status.passingScore,
                message: 'ì´ë¯¸ í•©ê²©í•œ í€´ì¦ˆì…ë‹ˆë‹¤.',
                status: 'PASS'
            });
        } else if (status.quizStatusCode === 'RETAKE_REQUIRED') {
            showRetakeRequired(status);
        } else if (status.quizStatusCode === 'RETRY_ALLOWED') {
            // 1ì°¨ ë¶ˆí•©ê²©, ì˜¤ë‹µí™•ì¸ í›„ 2ì°¨ ì‘ì‹œ ê°€ëŠ¥
            showFirstFailResult(status);
        } else {
            showError('ì‘ì‹œ ë¶ˆê°€', status.message || 'í€´ì¦ˆì— ì‘ì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    function showRetakeRequired(status) {
        document.getElementById('loadingView').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';
        document.getElementById('resultView').innerHTML = `
            <div class="result-container">
                <div class="result-icon">ğŸ“š</div>
                <h2 class="result-title fail">ì¬ìˆ˜ê°•ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                <p class="result-detail">ìµœê³  ì ìˆ˜: ${status.bestScore || 0}ì  / í•©ê²© ê¸°ì¤€: ${status.passingScore}ì </p>
                <div class="result-message">
                    ${status.message || '2ì°¨ ì‹œí—˜ì—ì„œë„ ë¶ˆí•©ê²©í•˜ì—¬ ê°•ì˜ë¥¼ ë‹¤ì‹œ ìˆ˜ê°•í•´ì•¼ í•©ë‹ˆë‹¤.'}
                </div>
                <div class="result-actions">
                    <button class="result-btn result-btn-primary" onclick="startRetake()">ì¬ìˆ˜ê°• ì‹œì‘í•˜ê¸°</button>
                    <a href="/course-detail?id=${courseId}" class="result-btn result-btn-secondary">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>
                </div>
            </div>`;
    }

    function showFirstFailResult(status) {
        document.getElementById('loadingView').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';
        document.getElementById('resultView').innerHTML = `
            <div class="result-container">
                <div class="result-icon">ğŸ“</div>
                <h2 class="result-title fail">1ì°¨ ì‹œí—˜ ë¶ˆí•©ê²©</h2>
                <p class="result-detail">ì ìˆ˜: ${status.bestScore || 0}ì  / í•©ê²© ê¸°ì¤€: ${status.passingScore}ì </p>
                <div class="result-message">
                    ì˜¤ë‹µì„ í™•ì¸í•˜ê±°ë‚˜ ë°”ë¡œ 2ì°¨ ì‹œí—˜ì— ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <div class="result-actions">
                    <button class="result-btn result-btn-primary" onclick="retakeQuiz()">2ì°¨ ì‹œí—˜ ì‘ì‹œí•˜ê¸°</button>
                    <button class="result-btn result-btn-secondary" onclick="loadReview(${status.quizId}, 1)">ì˜¤ë‹µ í™•ì¸í•˜ê¸°</button>
                </div>
            </div>`;
    }

    // ============ í€´ì¦ˆ ë Œë”ë§ ============
    function renderQuiz() {
        document.getElementById('loadingView').style.display = 'none';
        document.getElementById('quizView').style.display = 'block';

        document.getElementById('quizTitle').textContent = quizData.title;
        document.getElementById('quizDesc').textContent = quizData.description || '';
        document.getElementById('quizQuestionCount').textContent = quizData.totalQuestions + 'ë¬¸ì œ';
        document.getElementById('quizPassingScore').textContent = 'í•©ê²© ê¸°ì¤€: ' + quizData.passingScore + 'ì ';

        if (quizData.timeLimitSec && quizData.timeLimitSec > 0) {
            document.getElementById('timeLimitInfo').style.display = 'flex';
            document.getElementById('quizTimeLimit').textContent = 'ì œí•œì‹œê°„: ' + formatTimerTime(quizData.timeLimitSec);
            startTimer(quizData.timeLimitSec);
        }

        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';

        quizData.questions.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = 'question-' + q.id;

            let optionsHtml = '';
            q.options.forEach(opt => {
                optionsHtml += `
                    <div class="option-item" data-question-id="${q.id}" data-option-id="${opt.id}" onclick="selectOption(${q.id}, ${opt.id})">
                        <div class="option-radio"></div>
                        <span class="option-text">${escapeHtml(opt.content)}</span>
                    </div>`;
            });

            card.innerHTML = `
                <div class="question-number">ë¬¸ì œ ${idx + 1}</div>
                <div class="question-text">${escapeHtml(q.question)}</div>
                <div class="option-list">${optionsHtml}</div>`;

            container.appendChild(card);
        });

        updateAnsweredCount();
    }

    // ============ ì„ íƒì§€ ì„ íƒ ============
    function selectOption(questionId, optionId) {
        selectedAnswers[questionId] = optionId;

        // UI ê°±ì‹ 
        const items = document.querySelectorAll(`.option-item[data-question-id="${questionId}"]`);
        items.forEach(item => {
            if (parseInt(item.dataset.optionId) === optionId) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });

        updateAnsweredCount();
    }

    function updateAnsweredCount() {
        const total = quizData ? quizData.questions.length : 0;
        const answered = Object.keys(selectedAnswers).length;
        const countEl = document.getElementById('answeredCount');
        if (countEl) countEl.textContent = answered + ' / ' + total + ' ë‹µë³€';

        const notice = document.getElementById('unansweredNotice');
        if (answered < total) {
            notice.style.display = 'block';
            notice.textContent = (total - answered) + 'ê°œì˜ ë¯¸ë‹µë³€ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.';
        } else {
            notice.style.display = 'none';
        }
    }

    // ============ íƒ€ì´ë¨¸ ============
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function startTimer(totalSec) {
        stopTimer(); // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì •ë¦¬
        remainingSec = totalSec;
        document.getElementById('timerBar').style.display = 'flex';
        updateTimerDisplay();

        timerInterval = setInterval(() => {
            remainingSec--;
            updateTimerDisplay();

            if (remainingSec <= 0) {
                stopTimer();
                // alert ëŒ€ì‹  ë¹„ë¸”ë¡œí‚¹ ë°©ì‹ìœ¼ë¡œ ì•ˆë‚´ í›„ ìë™ ì œì¶œ
                const notice = document.getElementById('unansweredNotice');
                if (notice) {
                    notice.style.display = 'block';
                    notice.textContent = 'ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì œì¶œí•©ë‹ˆë‹¤.';
                    notice.style.color = '#c62828';
                }
                submitQuiz();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const el = document.getElementById('timerText');
        const bar = document.getElementById('timerBar');
        el.textContent = formatTimerTime(remainingSec);

        el.className = 'timer-text';
        bar.className = 'quiz-timer';

        if (remainingSec <= 60) {
            el.classList.add('danger');
            bar.classList.add('danger');
        } else if (remainingSec <= 300) {
            el.classList.add('warning');
            bar.classList.add('warning');
        }
    }

    function formatTimerTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // ============ ì œì¶œ ============
    async function submitQuiz() {
        if (isSubmitting) return; // ì¤‘ë³µ ì œì¶œ ë°©ì§€
        isSubmitting = true;
        stopTimer();

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'ì œì¶œ ì¤‘...';

        const answers = quizData.questions.map(q => ({
            questionId: q.id,
            selectedOptionId: selectedAnswers[q.id] || null
        }));

        try {
            const res = await fetch('/api/quiz/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quizId: quizData.id, answers: answers })
            });
            const data = await res.json();

            if (data.success && data.data) {
                showResult(data.data);
            } else {
                showError('ì œì¶œ ì‹¤íŒ¨', data.message || 'ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            console.error('Submit error:', e);
            showError('ì œì¶œ ì˜¤ë¥˜', 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            isSubmitting = false;
        }
    }

    // ============ ê²°ê³¼ í‘œì‹œ ============
    function showResult(result) {
        document.getElementById('loadingView').style.display = 'none';
        document.getElementById('quizView').style.display = 'none';
        document.getElementById('reviewView').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';

        const passed = result.passed;
        const score = result.scorePercent;
        const passing = result.passingScore || (quizData ? quizData.passingScore : 80);
        const total = result.totalQuestions || (quizData ? quizData.questions.length : 0);
        const correct = result.correctCount || 0;

        let icon, title, message, actions;

        if (passed) {
            icon = 'ğŸ‰';
            title = 'ì¶•í•˜í•©ë‹ˆë‹¤! í•©ê²©!';
            message = 'í€´ì¦ˆë¥¼ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤.';
            actions = `
                <a href="/course-detail?id=${courseId}" class="result-btn result-btn-success">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>`;
        } else if (result.status === 'RETRY_ALLOWED') {
            icon = 'ğŸ“';
            title = '1ì°¨ ì‹œí—˜ ë¶ˆí•©ê²©';
            message = 'ì˜¤ë‹µì„ í™•ì¸í•˜ê±°ë‚˜ ë°”ë¡œ 2ì°¨ ì‹œí—˜ì— ì‘ì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
            actions = `
                <button class="result-btn result-btn-primary" onclick="retakeQuiz()">2ì°¨ ì‹œí—˜ ì‘ì‹œí•˜ê¸°</button>
                <button class="result-btn result-btn-secondary" onclick="loadReview(${quizData.id}, ${result.attemptNo})">ì˜¤ë‹µ í™•ì¸í•˜ê¸°</button>
                <a href="/course-detail?id=${courseId}" class="result-btn result-btn-secondary">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>`;
        } else if (result.status === 'RETAKE_REQUIRED') {
            icon = 'ğŸ“š';
            title = '2ì°¨ ì‹œí—˜ ë¶ˆí•©ê²©';
            message = 'ê°•ì˜ë¥¼ ë‹¤ì‹œ ìˆ˜ê°•í•œ í›„ í€´ì¦ˆì— ì‘ì‹œí•´ì£¼ì„¸ìš”.';
            actions = `
                <button class="result-btn result-btn-primary" onclick="startRetake()">ì¬ìˆ˜ê°• ì‹œì‘í•˜ê¸°</button>
                <a href="/course-detail?id=${courseId}" class="result-btn result-btn-secondary">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>`;
        } else {
            icon = 'âŒ';
            title = 'ë¶ˆí•©ê²©';
            message = result.message || '';
            actions = `<a href="/course-detail?id=${courseId}" class="result-btn result-btn-secondary">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>`;
        }

        document.getElementById('resultView').innerHTML = `
            <div class="result-container">
                <div class="result-icon">${icon}</div>
                <h2 class="result-title ${passed ? 'pass' : 'fail'}">${title}</h2>
                <div class="result-score ${passed ? 'pass' : 'fail'}">${score}ì </div>
                <p class="result-detail">${total}ë¬¸ì œ ì¤‘ ${correct}ë¬¸ì œ ì •ë‹µ (í•©ê²© ê¸°ì¤€: ${passing}ì )</p>
                <div class="result-message">${message}</div>
                <div class="result-actions">${actions}</div>
            </div>`;
    }

    // ============ ì˜¤ë‹µ í™•ì¸ ============
    async function loadReview(quizId, attemptNo) {
        document.getElementById('resultView').style.display = 'none';
        document.getElementById('reviewView').style.display = 'block';
        document.getElementById('reviewView').innerHTML = '<div class="quiz-loading"><div class="spinner"></div><p>ì˜¤ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

        try {
            const res = await fetch(`/api/quiz/${quizId}/review?attemptNo=${attemptNo}`);
            const data = await res.json();

            if (!data.success || !data.data) {
                document.getElementById('reviewView').innerHTML = `
                    <div class="quiz-error">
                        <h2>ì˜¤ë‹µ í™•ì¸ ë¶ˆê°€</h2>
                        <p>${data.message || 'ì˜¤ë‹µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
                        <a href="/course-detail?id=${courseId}">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>
                    </div>`;
                return;
            }

            renderReview(data.data);
        } catch (e) {
            console.error('Review load error:', e);
            document.getElementById('reviewView').innerHTML = `
                <div class="quiz-error">
                    <h2>ì˜¤ë¥˜</h2>
                    <p>ì˜¤ë‹µ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    <a href="/course-detail?id=${courseId}">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>
                </div>`;
        }
    }

    function renderReview(review) {
        let html = `
            <div class="quiz-header">
                <h1 class="quiz-title">ì˜¤ë‹µ í™•ì¸</h1>
                <p class="quiz-desc">ì ìˆ˜: ${review.scorePercent}ì  | ${review.attemptNo}ì°¨ ì‹œí—˜</p>
            </div>`;

        review.questions.forEach((q, idx) => {
            const isCorrect = q.isCorrect;
            const badgeClass = isCorrect ? 'correct' : 'wrong';
            const badgeText = isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ';

            let optionsHtml = '';
            q.options.forEach(opt => {
                let cls = '';
                if (opt.id === q.correctOptionId) cls = 'correct';
                else if (opt.id === q.selectedOptionId && !isCorrect) cls = 'wrong';

                optionsHtml += `
                    <div class="option-item ${cls}" style="cursor: default;">
                        <div class="option-radio"></div>
                        <span class="option-text">${escapeHtml(opt.content)}</span>
                        ${opt.id === q.correctOptionId ? '<span style="margin-left: auto; color: #2e7d32; font-size: 13px; font-weight: 600;">ì •ë‹µ</span>' : ''}
                        ${opt.id === q.selectedOptionId && opt.id !== q.correctOptionId ? '<span style="margin-left: auto; color: #c62828; font-size: 13px; font-weight: 600;">ë‚´ ì„ íƒ</span>' : ''}
                    </div>`;
            });

            html += `
                <div class="question-card">
                    <div class="question-number">
                        ë¬¸ì œ ${idx + 1}
                        <span class="question-result-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="question-text">${escapeHtml(q.question)}</div>
                    <div class="option-list">${optionsHtml}</div>
                    ${q.explanation ? `<div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 14px; color: #555;"><strong>í•´ì„¤:</strong> ${escapeHtml(q.explanation)}</div>` : ''}
                </div>`;
        });

        html += `
            <div class="quiz-submit-area">
                <div class="result-actions">
                    <button class="result-btn result-btn-primary" onclick="retakeQuiz()">2ì°¨ ì‹œí—˜ ì‘ì‹œí•˜ê¸°</button>
                    <a href="/course-detail?id=${courseId}" class="result-btn result-btn-secondary">ê°•ì¢Œë¡œ ëŒì•„ê°€ê¸°</a>
                </div>
            </div>`;

        document.getElementById('reviewView').innerHTML = html;
    }

    // ============ 2ì°¨ ì‹œí—˜ ì‘ì‹œ ============
    function retakeQuiz() {
        // ì „ì²´ ìƒíƒœ ì´ˆê¸°í™”
        selectedAnswers = {};
        isSubmitting = false;
        stopTimer();

        document.getElementById('reviewView').style.display = 'none';
        document.getElementById('resultView').style.display = 'none';
        document.getElementById('loadingView').style.display = 'block';
        document.getElementById('timerBar').style.display = 'none';

        // ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        const btn = document.getElementById('submitBtn');
        btn.disabled = false;
        btn.textContent = 'ì œì¶œí•˜ê¸°';

        init();
    }

    // ============ ì¬ìˆ˜ê°• ì‹œì‘ ============
    function startRetake() {
        const csrf = document.querySelector('meta[name="_csrf"]')?.content || '';
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/courses/' + courseId + '/retake';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_csrf';
        input.value = csrf;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // ============ ì—ëŸ¬/ìœ í‹¸ ============
    function showError(title, message) {
        document.getElementById('loadingView').style.display = 'none';
        document.getElementById('errorView').style.display = 'block';
        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorMessage').textContent = message;
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ì‹œì‘
    init();
</script>
</body>
</html>
