<!-- templates/lesson.html -->
<div th:fragment="lessonContent" class="container lesson">

    <!-- ✅ 접근 불가 (수강 권한 없음) -->
    <div th:if="${!canAccess}" class="lesson-container">
        <div class="access-denied">
            <h2>접근 권한이 없습니다</h2>
            <p th:if="${enrollment == null}">이 강좌를 수강하려면 먼저 수강 신청을 해주세요.</p>
            <p th:if="${enrollment != null and enrollment.status.name() == 'REQUESTED'}">수강 신청이 승인 대기 중입니다. 관리자 승인 후 학습이 가능합니다.</p>
            <p th:if="${enrollment != null and enrollment.status.name() == 'REJECTED'}">수강 신청이 반려되었습니다.</p>

            <!-- ✅ course-detail: 웹/유니티 분기 -->
            <a th:href="${isUnity} ? @{/course-detail-unity(id=${course.id})} : @{/course-detail(id=${course.id})}">
                강좌 상세로 이동
            </a>
        </div>
    </div>

    <!-- ✅ 레슨 시청 (수강 권한 있음) -->
    <div th:if="${canAccess}" class="lesson-container">
        <div class="lesson-header">

            <!-- ✅ course-detail: 웹/유니티 분기 -->
            <a th:href="${isUnity} ? @{/course-detail-unity(id=${course.id})} : @{/course-detail(id=${course.id})}"
               class="lesson-back">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span th:text="${course.title}">강좌명</span>
            </a>

            <h1 class="lesson-title" th:text="${lesson.sortOrder + '강. ' + lesson.title}">레슨 제목</h1>
            <div class="lesson-meta">
                <span th:text="${lesson.formattedDuration}">15분</span>
                <span th:text="${course.categoryDisplayName}">카테고리</span>
            </div>
        </div>

        <div class="lesson-content">
            <div class="main-content">
                <!-- 비디오 플레이어 -->
                <div class="video-wrapper">
                    <div class="video-container">
                        <!-- YouTube -->
                        <th:block th:if="${lesson.videoType.name() == 'YOUTUBE'}">
                            <iframe id="youtube-player"
                                    th:src="${youtubeEmbedUrl}"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen>
                            </iframe>
                        </th:block>

                        <!-- MP4/HLS -->
                        <th:block th:if="${lesson.videoType.name() == 'MP4' or lesson.videoType.name() == 'HLS'}">
                            <video id="video-player" controls th:src="${lesson.videoUrl}">
                                브라우저가 비디오를 지원하지 않습니다.
                            </video>
                        </th:block>

                        <!-- 영상 없음 -->
                        <th:block th:if="${lesson.videoType.name() == 'NONE'}">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #333; color: white;">
                                <p>이 레슨에는 영상이 없습니다.</p>
                            </div>
                        </th:block>
                    </div>
                </div>

                <!-- 진도 정보 -->
                <div class="progress-card">
                    <div class="progress-header">
                        <span class="progress-title">이 레슨 진도</span>
                        <span class="progress-percent" id="lessonProgress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="lessonProgressBar" style="width: 0%;"></div>
                    </div>
                    <div class="progress-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="watchedTime">0분</div>
                            <div class="stat-label">시청 시간</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalTime" th:text="${lesson.formattedDuration}">0분</div>
                            <div class="stat-label">전체 시간</div>
                        </div>
                    </div>

                    <button class="complete-btn" id="completeBtn" onclick="markComplete()">
                        레슨 완료하기
                    </button>

                    <!-- 퀴즈 안내 -->
                    <div id="quizNotice" style="display: none; margin-top: 15px; padding: 14px 18px; background: #fff3e0; border-radius: 8px; text-align: center;">
                        <span id="quizNoticeText" style="font-size: 14px; color: #e65100;"></span>

                        <!-- ✅ quiz: 웹/유니티 분기 (JS가 href를 세팅할 때 base를 알아야 해서 data 속성 제공) -->
                        <a id="quizNoticeLink"
                           href="#"
                           th:attr="data-quiz-web=@{/quiz(courseId=${course.id})},
                                    data-quiz-unity=@{/quiz-unity(courseId=${course.id})}"
                           style="display: block; margin-top: 8px; padding: 10px; background: var(--primary-red); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;">
                            퀴즈 응시하기
                        </a>
                    </div>
                </div>
            </div>

            <!-- 사이드바: 커리큘럼 -->
            <div class="sidebar">
                <div class="curriculum-card">
                    <div class="curriculum-header">
                        <h3 class="curriculum-title">커리큘럼</h3>
                    </div>
                    <div class="curriculum-list">
                        <div th:each="item : ${allLessons}"
                             class="curriculum-item"
                             th:classappend="${(item.id == lesson.id ? 'active' : '') + ' ' + (progressMap != null and progressMap.containsKey(item.id) and progressMap.get(item.id).completed ? 'completed' : '')}"
                             th:attr="data-lesson-web=@{/lesson(courseId=${course.id}, lessonId=${item.id})},
              data-lesson-unity=@{/lesson-unity(courseId=${course.id}, lessonId=${item.id})},
              data-is-unity=${isUnity}"
                             th:onclick="'goToLesson(' + ${item.id} + ')'">
                            <div class="item-number">
                                <th:block th:if="${progressMap != null and progressMap.containsKey(item.id) and progressMap.get(item.id).completed}">✓</th:block>
                                <th:block th:unless="${progressMap != null and progressMap.containsKey(item.id) and progressMap.get(item.id).completed}"
                                          th:text="${item.sortOrder}">1</th:block>
                            </div>
                            <div class="item-info">
                                <div class="item-title" th:text="${item.title}">레슨명</div>
                                <div class="item-duration" th:text="${item.formattedDuration}">15분</div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ✅ JS가 읽을 수 있도록 isUnity도 같이 내려줌 -->
<input type="hidden" id="isUnity" th:value="${isUnity}">
</div>