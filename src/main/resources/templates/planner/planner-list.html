<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì—¬í–‰ í”Œë˜ë„ˆ - æ—¥æœ¬ Travel LMS</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/planner.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <!-- í—¤ë” -->
    <th:block th:replace="~{fragments/main-header :: mainHeader}"></th:block>

    <main class="planner-list-page">
        <div class="planner-list-container">
            <!-- í—¤ë” -->
            <div class="planner-list-header">
                <div>
                    <h1>ë‚´ ì—¬í–‰ í”Œë˜ë„ˆ</h1>
                    <p>ë…¸ì…˜ ìŠ¤íƒ€ì¼ë¡œ ì—¬í–‰ì„ ì²´ê³„ì ìœ¼ë¡œ ê³„íší•˜ì„¸ìš”</p>
                </div>
                <div class="planner-list-actions">
                    <a th:href="@{/planner/explore}" class="btn-explore-planner">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
                        </svg>
                        ë‘˜ëŸ¬ë³´ê¸°
                    </a>
                    <button type="button" class="btn-new-planner" onclick="openCreateModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        ìƒˆ í”Œë˜ë„ˆ ë§Œë“¤ê¸°
                    </button>
                </div>
            </div>

            <!-- í”Œë˜ë„ˆ ëª©ë¡ -->
            <div id="plannerGrid" class="planner-cards-grid">
                <!-- ë¡œë”© ìƒíƒœ -->
                <div class="planner-loading" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p>í”Œë˜ë„ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- ë¹ˆ ìƒíƒœ (í”Œë˜ë„ˆê°€ ì—†ì„ ë•Œ) -->
            <div id="plannerEmpty" class="planner-empty" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <h3>ì•„ì§ ì—¬í–‰ í”Œë˜ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì²« ì—¬í–‰ ê³„íšì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
                <button type="button" class="btn-empty-create" onclick="openCreateModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    ìƒˆ í”Œë˜ë„ˆ ë§Œë“¤ê¸°
                </button>
            </div>
        </div>
    </main>

    <!-- í”Œë˜ë„ˆ ìƒì„± ëª¨ë‹¬ -->
    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ìƒˆ ì—¬í–‰ í”Œë˜ë„ˆ ë§Œë“¤ê¸°</h2>
                <button type="button" class="btn-modal-close" onclick="closeCreateModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <form id="createPlannerForm" onsubmit="submitCreatePlanner(event)">
                <div class="modal-body">
                    <!-- ì—¬í–‰ ì œëª© -->
                    <div class="form-group">
                        <label for="plannerTitle">ì—¬í–‰ ì œëª©</label>
                        <input type="text" id="plannerTitle" name="title" class="form-input"
                               placeholder="ì˜ˆ: ë„ì¿„ ë²šê½ƒ ì—¬í–‰" required>
                    </div>

                    <!-- ì—¬í–‰ì§€ -->
                    <div class="form-group">
                        <label for="plannerDestination">ì—¬í–‰ì§€</label>
                        <div class="form-input-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            <input type="text" id="plannerDestination" name="destination" class="form-input"
                                   placeholder="ë„ì‹œ, ì§€ì—­ ì…ë ¥" required>
                        </div>
                    </div>

                    <!-- ë‚ ì§œ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="plannerStartDate">ì‹œì‘ì¼</label>
                            <div class="form-input-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <input type="date" id="plannerStartDate" name="startDate" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="plannerEndDate">ì¢…ë£Œì¼</label>
                            <div class="form-input-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <input type="date" id="plannerEndDate" name="endDate" class="form-input" required>
                            </div>
                        </div>
                    </div>

                    <!-- í…œí”Œë¦¿ ì„ íƒ -->
                    <div class="form-group">
                        <label>í…œí”Œë¦¿ ì„ íƒ</label>
                        <div class="template-grid">
                            <div class="template-option selected" data-template="BLANK" onclick="selectTemplate(this)">
                                <div class="template-option-icon">ğŸ“</div>
                                <div class="template-option-name">ë¹ˆ í”Œë˜ë„ˆ</div>
                            </div>
                            <div class="template-option" data-template="CITY" onclick="selectTemplate(this)">
                                <div class="template-option-icon">ğŸ™ï¸</div>
                                <div class="template-option-name">ë„ì‹œ íƒë°©</div>
                            </div>
                            <div class="template-option" data-template="NATURE" onclick="selectTemplate(this)">
                                <div class="template-option-icon">ğŸ”ï¸</div>
                                <div class="template-option-name">ìì—° ì—¬í–‰</div>
                            </div>
                            <div class="template-option" data-template="FOOD" onclick="selectTemplate(this)">
                                <div class="template-option-icon">ğŸœ</div>
                                <div class="template-option-name">ë§›ì§‘ íˆ¬ì–´</div>
                            </div>
                            <div class="template-option" data-template="CULTURE" onclick="selectTemplate(this)">
                                <div class="template-option-icon">â›©ï¸</div>
                                <div class="template-option-name">ë¬¸í™” ì²´í—˜</div>
                            </div>
                            <div class="template-option" data-template="SHOPPING" onclick="selectTemplate(this)">
                                <div class="template-option-icon">ğŸ›ï¸</div>
                                <div class="template-option-name">ì‡¼í•‘ ì—¬í–‰</div>
                            </div>
                        </div>
                        <input type="hidden" id="plannerTemplate" name="template" value="BLANK">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-modal-cancel" onclick="closeCreateModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-modal-submit">í”Œë˜ë„ˆ ë§Œë“¤ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í”Œë˜ë„ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.header-nav a');
            navLinks.forEach(link => {
                if (link.getAttribute('href').includes('/planner')) {
                    link.classList.add('active');
                }
            });

            loadMyPlanners();
        });

        // ë‚´ í”Œë˜ë„ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMyPlanners() {
            const grid = document.getElementById('plannerGrid');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('plannerEmpty');

            try {
                const response = await fetch('/api/planner/my');
                const planners = await response.json();

                loadingState.style.display = 'none';

                if (planners.length === 0) {
                    grid.style.display = 'none';
                    emptyState.style.display = 'flex';
                    return;
                }

                grid.innerHTML = planners.map(planner => createPlannerCard(planner)).join('');

            } catch (error) {
                console.error('Error loading planners:', error);
                loadingState.innerHTML = '<p>í”Œë˜ë„ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // í”Œë˜ë„ˆ ì¹´ë“œ HTML ìƒì„±
        function createPlannerCard(planner) {
            const coverImage = planner.coverImage || 'https://images.unsplash.com/photo-1493976040374-85cb44e25828?w=600&q=80';
            const destination = planner.destination || 'ë¯¸ì •';
            const dateRange = planner.startDate && planner.endDate
                ? `${planner.startDate} ~ ${planner.endDate}`
                : 'ë‚ ì§œ ë¯¸ì •';
            const isPublic = planner.visibility === 'PUBLIC';

            return `
                <a href="/planner/detail/${planner.id}" class="planner-card">
                    <div class="planner-card-image">
                        <img src="${coverImage}" alt="${planner.title}">
                        <div class="planner-card-visibility ${isPublic ? 'public' : 'private'}">
                            ${isPublic ? `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                                ê³µê°œ
                            ` : `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                                ë¹„ê³µê°œ
                            `}
                        </div>
                    </div>
                    <div class="planner-card-content">
                        <h3 class="planner-card-title">${planner.title}</h3>
                        <div class="planner-card-info">
                            <div class="planner-card-info-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <span>${destination}</span>
                            </div>
                            <div class="planner-card-info-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <span>${dateRange}</span>
                            </div>
                        </div>
                        <div class="planner-card-footer">
                            <span class="planner-card-days">${planner.days}ì¼</span>
                            <div class="planner-card-stats">
                                <span class="stat-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    ${planner.viewCount || 0}
                                </span>
                                <span class="stat-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                    </svg>
                                    ${planner.likeCount || 0}
                                </span>
                            </div>
                            <button type="button" class="btn-delete-planner" onclick="event.preventDefault(); deletePlanner(${planner.id})">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </a>
            `;
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // í…œí”Œë¦¿ ì„ íƒ
        function selectTemplate(element) {
            document.querySelectorAll('.template-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            document.getElementById('plannerTemplate').value = element.dataset.template;
        }

        // í”Œë˜ë„ˆ ìƒì„± ì œì¶œ
        async function submitCreatePlanner(event) {
            event.preventDefault();

            const formData = {
                title: document.getElementById('plannerTitle').value,
                destination: document.getElementById('plannerDestination').value,
                startDate: document.getElementById('plannerStartDate').value,
                endDate: document.getElementById('plannerEndDate').value,
                template: document.getElementById('plannerTemplate').value
            };

            try {
                const response = await fetch('/api/planner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = '/planner/detail/' + result.plannerId;
                } else {
                    alert('í”Œë˜ë„ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Error creating planner:', error);
                alert('í”Œë˜ë„ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í”Œë˜ë„ˆ ì‚­ì œ
        async function deletePlanner(id) {
            if (!confirm('ì •ë§ ì´ í”Œë˜ë„ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/planner/${id}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                const result = await response.json();

                if (result.success) {
                    loadMyPlanners();
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Error deleting planner:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('createModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreateModal();
            }
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateModal();
            }
        });
    </script>
</body>
</html>
