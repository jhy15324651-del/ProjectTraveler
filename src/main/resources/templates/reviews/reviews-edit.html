<!-- templates/reviews/reviews-edit.html -->
<div th:fragment="reviewsEditContent" class="container reviews-post">

    <div class="reviews-post-title-row">
        <h1 class="page-title">✏️ 후기 다듬기!</h1>

        <!-- 상세로 돌아가기 -->
        <a class="back-btn"
           th:href="${isUnity == true}
                ? @{/reviews-unity/{id}(id=${request.id})}
                : @{/reviews/{id}(id=${request.id})}">
            ← 돌아가기
        </a>
    </div>

    <!-- ✅ 수정도 POST /reviews 그대로 사용 -->
    <form id="postForm" method="post" th:action="@{/reviews}" th:object="${request}">

        <!-- ✅ Spring Security CSRF -->
        <input type="hidden"
               th:if="${_csrf != null}"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}"/>

        <!-- ✅ 수정 필수: id 전달 -->
        <input type="hidden" th:field="*{id}">

        <!-- 유니티 분기용 -->
        <input type="hidden" name="fromUnity" th:value="${isUnity == true} ? '1' : '0'" value="0"/>

        <!-- ✅ JS 복원 힌트(단일 선택) -->
        <input type="hidden" id="initTravelType" th:value="*{travelType}">
        <input type="hidden" id="initPeriod"     th:value="*{period}">
        <input type="hidden" id="initLevel"      th:value="*{level}">

        <!-- ✅ JS 복원 힌트(지역 다중) : request.regionTags 배열을 data-*로 심기 -->
        <div id="initRegionTags"
             th:attr="data-tags=${request.regionTags != null ? #strings.arrayJoin(request.regionTags, ',') : ''}"
             style="display:none;"></div>

        <!-- 제목 -->
        <section class="write-section">
            <label class="write-label">제목</label>
            <input type="text"
                   class="write-input"
                   th:field="*{title}">
        </section>

        <!-- 예산 -->
        <section class="write-section">
            <label class="write-label">사용 경비</label>

            <div class="budget-grid" id="budgetGrid">
                <div class="budget-item">
                    <span class="b-label">항공</span>
                    <input type="text" class="b-input" inputmode="numeric" placeholder="0"
                           th:field="*{budgetFlight}">
                    <span class="unit">만 원</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">숙박</span>
                    <input type="text" class="b-input" inputmode="numeric" placeholder="0"
                           th:field="*{budgetLodging}">
                    <span class="unit">만 원</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">식비</span>
                    <input type="text" class="b-input" inputmode="numeric" placeholder="0"
                           th:field="*{budgetFood}">
                    <span class="unit">만 원</span>
                </div>

                <div class="budget-item">
                    <span class="b-label">기타</span>
                    <input type="text" class="b-input" inputmode="numeric" placeholder="0"
                           th:field="*{budgetExtra}">
                    <span class="unit">만 원</span>
                </div>
            </div>
        </section>

        <!-- 태그 선택 -->
        <section class="write-section">
            <!-- 여행 유형 (단일) -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">여행 유형</div>
                    <div class="filter-hint single">한 개만 선택</div>
                </div>

                <div class="filter-chips" data-key="travelType" data-mode="single">
                    <button type="button" class="chip" data-value="solo">혼자</button>
                    <button type="button" class="chip" data-value="couple">커플</button>
                    <button type="button" class="chip" data-value="family">가족</button>
                    <button type="button" class="chip" data-value="friends">친구</button>
                </div>

                <input type="hidden" th:field="*{travelType}">
            </div>

            <!-- 테마 (다중) -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">테마</div>
                    <div class="filter-hint multi">중복 선택 가능</div>
                </div>

                <!-- ✅ single -> multi-or -->
                <div class="filter-chips" data-key="theme" data-mode="multi-or">
                    <button type="button" class="chip" data-value="freedom">자유</button>
                    <button type="button" class="chip" data-value="healing">힐링</button>
                    <button type="button" class="chip" data-value="food">맛집</button>
                    <button type="button" class="chip" data-value="activity">액티비티</button>
                    <button type="button" class="chip" data-value="nature">자연</button>
                </div>

                <!-- ✅ List<String> themes 전송용 hidden inputs -->
                <div id="themeInputs">
                    <input th:each="t : ${request != null ? request.themes : null}"
                           type="hidden" name="themes" th:value="${t}"/>
                </div>
            </div>

            <!-- 기간 (단일) -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">기간</div>
                    <div class="filter-hint single">한 개만 선택</div>
                </div>

                <div class="filter-chips" data-key="period" data-mode="single">
                    <button type="button" class="chip" data-value="당일치기">당일</button>
                    <button type="button" class="chip" data-value="1박2일">1박2일</button>
                    <button type="button" class="chip" data-value="2박3일">2박3일</button>
                    <button type="button" class="chip" data-value="3박4일">3박4일</button>
                </div>

                <input type="hidden" th:field="*{period}">
            </div>

            <!-- 난이도 (단일) -->
            <div class="filter-row">
                <div>
                    <div class="filter-label">난이도</div>
                    <div class="filter-hint single">한 개만 선택</div>
                </div>

                <div class="filter-chips" data-key="level" data-mode="single">
                    <button type="button" class="chip" data-value="초급">초급</button>
                    <button type="button" class="chip" data-value="중급">중급</button>
                    <button type="button" class="chip" data-value="상급">상급</button>
                </div>

                <input type="hidden" th:field="*{level}">
            </div>

            <!-- 지역 (다중) -->
            <div class="filter-row region-row">
                <div class="region-left">
                    <div class="filter-label">지역</div>
                    <div class="filter-hint multi">중복 선택 가능</div>
                </div>

                <div class="region-main-col">
                    <div class="filter-chips region-main">
                        <button type="button" class="chip region-main-btn region-all" data-group="">↺</button>

                        <button type="button"
                                class="chip region-main-btn"
                                th:each="entry : ${regionGroups}"
                                th:data-group="${entry.key}"
                                th:text="${entry.key}">
                            상위지역
                        </button>
                    </div>
                </div>

                <div class="region-sub-left" id="regionSubLabel" style="display:none;">
                    * 세부 지역 선택
                </div>

                <div class="region-sub-col">
                    <div class="region-sub-wrap" id="regionSubWrap" style="display:none;">
                        <div class="filter-chips region-sub" data-key="region" data-mode="multi">
                            <th:block th:each="entry : ${regionGroups}">
                                <button type="button"
                                        class="chip"
                                        th:each="sub : ${entry.value}"
                                        th:data-group="${entry.key}"
                                        th:data-value="${sub}"
                                        th:text="${sub}"
                                        style="display:none;">
                                    세부지역
                                </button>
                            </th:block>
                        </div>
                    </div>
                </div>

                <!-- ✅ JS가 regionTags inputs 생성 -->
                <div class="region-inputs" id="regionInputs"></div>
            </div>

            <div class="tag-summary-mini" id="miniSummary">
                <span class="empty">선택된 조건 없음</span>
            </div>
        </section>

        <!-- 내용 -->
        <section class="write-section">
            <label class="write-label">여행 후기 내용</label>
            <div id="editor"></div>
            <input type="hidden" id="content" th:field="*{content}">
        </section>

        <!-- 제출 -->
        <section class="write-section">
            <button type="submit" class="submit-btn">수정 저장</button>
        </section>

    </form>
</div>
