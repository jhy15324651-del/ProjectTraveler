<!-- templates/reviews/reviews.html -->
<div th:fragment="reviewsContent" class="container reviews">

    <!-- HERO (same style as info) -->
    <section class="page-hero">
        <div class="page-heroBox">
            <div class="page-heroBox__inner">
                <h1 class="page-heroBox__title">여행 후기</h1>
                <p class="page-heroBox__desc">여행 유형/테마/예산/기간/난이도/지역으로 후기를 탐색할 수 있습니다.</p>

                <a class="write-btn"
                   th:href="${isUnity == true} ? @{/reviews-unity-post} : @{/reviews-post}">
                    ✈️ 지금 후기 작성하러가기!
                </a>
            </div>
        </div>
    </section>

    <!-- =========================
         Filter Panel (GET)
    ========================== -->
    <form id="filterForm" method="get">

        <!-- paging -->
        <input type="hidden" id="f_page" name="page"
               th:value="${search != null && search.page != null ? search.page : 0}" value="0"/>

        <h1 class="page-title-sub">🔍 내게 맞는 후기 찾아보기</h1>

        <section class="filter-panel">

            <!-- travelType (single) -->
            <div class="filter-row">
                <div class="filter-label">
                    여행유형
                    <div class="filter-hint single">* 한 개만 선택</div>
                </div>

                <div class="filter-chips" data-key="travelType" data-mode="single">
                    <button type="button" class="chip" data-value="">전체</button>
                    <button type="button" class="chip" data-value="solo">혼자</button>
                    <button type="button" class="chip" data-value="couple">커플</button>
                    <button type="button" class="chip" data-value="family">가족</button>
                    <button type="button" class="chip" data-value="friends">친구</button>
                </div>

                <input type="hidden" id="f_travelType" name="travelType"
                       th:value="${search != null ? search.travelType : ''}" value=""/>
            </div>

            <!-- theme (single) -->
            <div class="filter-row">
                <div class="filter-label">
                    테마
                    <div class="filter-hint single">* 한 개만 선택</div>
                </div>

                <div class="filter-chips" data-key="theme" data-mode="single">
                    <button type="button" class="chip" data-value="">전체</button>
                    <button type="button" class="chip" data-value="freedom">자유</button>
                    <button type="button" class="chip" data-value="healing">힐링</button>
                    <button type="button" class="chip" data-value="food">맛집</button>
                    <button type="button" class="chip" data-value="activity">액티비티</button>
                    <button type="button" class="chip" data-value="nature">자연</button>
                </div>

                <input type="hidden" id="f_theme" name="theme"
                       th:value="${search != null ? search.theme : ''}" value=""/>
            </div>

            <!-- budget -->
            <div class="filter-row">
                <div class="filter-label budget-label">예산</div>

                <div class="reviews-budget">
                    <div class="reviews-budget-line">
                        <div class="reviews-budget-values">
                            <span id="budgetMinLabel">0원</span>
                            <span> ~ </span>
                            <span id="budgetMaxLabel">5,000,000원</span>
                        </div>

                        <div class="reviews-budget-slider">
                            <button type="button" id="budgetResetBtn" class="budget-reset-btn" title="예산 초기화">↺</button>

                            <div class="reviews-budget-track">
                                <div class="reviews-budget-range" id="budgetRange"></div>
                            </div>

                            <input type="range" id="budgetMin"
                                   min="0" max="5000000" step="100"
                                   th:value="${search != null and search.minBudget != null ? search.minBudget : 0}"
                                   value="0"/>

                            <input type="range" id="budgetMax"
                                   min="0" max="5000000" step="100"
                                   th:value="${search != null and search.maxBudget != null ? search.maxBudget : 5000000}"
                                   value="5000000"/>

                            <div class="reviews-budget-ticks" id="budgetTicks"></div>
                        </div>

                        <button type="button" id="budgetUnlockBtn" class="budget-unlock-btn">제한해제</button>
                    </div>

                    <!-- hidden -->
                    <input type="hidden" name="minBudget" id="f_minBudget"
                           th:value="${search != null and search.minBudget != null ? search.minBudget : 0}"
                           value="0">

                    <input type="hidden" name="maxBudget" id="f_maxBudget"
                           th:value="${search != null and search.maxBudget != null ? search.maxBudget : 5000000}"
                           value="5000000">

                    <!-- unlock 상태 -->
                    <input type="hidden" name="budgetUnlimit" id="f_budgetUnlimit"
                           th:value="${param.budgetUnlimit}" value="0">
                </div>
            </div>

            <!-- period (multi) -->
            <div class="filter-row">
                <div class="filter-label">
                    기간
                    <div class="filter-hint multi">* 중복 선택 가능</div>
                </div>

                <div class="filter-chips" data-key="period" data-mode="multi-or">
                    <button type="button" class="chip" data-value="">전체</button>
                    <button type="button" class="chip" data-value="당일치기">당일</button>
                    <button type="button" class="chip" data-value="1박2일">1박2일</button>
                    <button type="button" class="chip" data-value="2박3일">2박3일</button>
                    <button type="button" class="chip" data-value="3박4일">3박4일</button>
                </div>

                <div id="periodInputs">
                    <input th:each="p : ${search != null ? search.periods : null}"
                           type="hidden" name="periods" th:value="${p}"/>
                </div>
            </div>

            <!-- level (multi) -->
            <div class="filter-row">
                <div class="filter-label">
                    난이도
                    <div class="filter-hint multi">* 중복 선택 가능</div>
                </div>

                <div class="filter-chips" data-key="level" data-mode="multi-or">
                    <button type="button" class="chip" data-value="">전체</button>
                    <button type="button" class="chip" data-value="초급">초급</button>
                    <button type="button" class="chip" data-value="중급">중급</button>
                    <button type="button" class="chip" data-value="상급">상급</button>
                </div>

                <div id="levelInputs">
                    <input th:each="lv : ${search != null ? search.levels : null}"
                           type="hidden" name="levels" th:value="${lv}"/>
                </div>
            </div>

            <!-- region(tags) (multi / grouped) -->
            <div class="filter-row region-row">

                <!-- (1,1) 좌상: 기존 라벨 영역 -->
                <div class="filter-label region-left">
                    지역
                    <div class="filter-hint multi">* 중복 선택 가능</div>
                </div>

                <!-- (1,2) 우상: 상위칩 -->
                <div class="region-main-col">
                    <div class="filter-chips region-main" data-key="regionMain" data-mode="single">
                        <button type="button"
                                class="chip region-main-btn region-all"
                                data-group=""
                                th:classappend="${search == null || search.tags == null || #lists.isEmpty(search.tags)} ? ' active' : ''">
                            전체
                        </button>

                        <button type="button"
                                class="chip region-main-btn"
                                th:each="entry : ${regionGroups}"
                                th:data-group="${entry.key}"
                                th:text="${entry.key}">
                            상위지역
                        </button>
                    </div>
                </div>

                <!-- (2,1) 좌하: 세부지역 선택 라벨 (드롭다운 열릴 때만 보이기) -->
                <div id="regionSubLabel" class="region-sub-label" style="display:none;">
                    * 세부 지역 선택
                </div>

                <!-- (2,2) 우하: 하위칩 -->
                <div class="region-sub-col">
                    <div class="region-sub-wrap" id="regionSubWrap" style="display:none;">
                        <div class="filter-chips region-sub"
                             data-key="region"
                             data-mode="multi-toggle">

                            <th:block th:each="entry : ${regionGroups}">
                                <button type="button"
                                        class="chip"
                                        th:each="sub : ${entry.value}"
                                        th:data-group="${entry.key}"
                                        th:data-value="${sub}"
                                        th:text="${sub}"
                                        style="display:none;">
                                    세부지역
                                </button>
                            </th:block>

                        </div>
                    </div>
                </div>

                <!-- 안내문: 그리드 아래로 한 줄 전체 -->
                <div class="filter-hint sub one-line region-desc">
                    * 지역 중복 선택 시 선택한 지역이 모두 포함된 게시글이 먼저 보입니다.
                </div>

                <!-- hidden inputs -->
                <div id="tagInputs">
                    <input th:each="t : ${search != null ? search.tags : null}"
                           type="hidden" name="tags" th:value="${t}"/>
                </div>
            </div>


            <!-- search toolbar -->
            <div class="reviews search-toolbar">
                <div class="tag-summary-mini" id="miniSummary">
                    <span class="empty">선택된 조건 없음</span>
                </div>

                <div class="q-stack">
                    <select class="q-field">
                        <option value="tc">제목 + 내용</option>
                        <option value="t">제목</option>
                        <option value="c">내용</option>
                    </select>

                    <textarea name="q" class="q-input" rows="1" placeholder="검색어를 입력하세요"
                              th:text="${search != null ? search.q : ''}"></textarea>

                    <button type="submit" class="q-btn">검색</button>
                    <button type="button" id="btnReset" class="btn-reset">초기화</button>
                </div>
            </div>

        </section>
    </form>


    <!-- =========================
         Post List
    ========================== -->
    <section id="postList" class="post-list">
        <h1 class="page-title-sub">🗺️ 후기 둘러보기</h1>

        <article class="post-card" th:each="post : ${posts}">
            <a class="post-link"
               th:href="${isUnity == true}
                     ? @{/reviews-unity/{id}(id=${post.id})}
                     : @{/reviews/{id}(id=${post.id})}">

                <div class="post-thumb">
                    <img th:if="${post.thumbnailUrl != null}"
                         th:src="${post.thumbnailUrl}"
                         alt="thumbnail"/>

                    <div th:if="${post.thumbnailUrl == null}"
                         class="post-thumb--placeholder">
                        No Image
                    </div>
                </div>

                <div class="post-body">
                    <h3 class="post-title" th:text="${post.title}">제목</h3>

                    <div class="post-meta">
                        <span class="badge match"
                              th:if="${post.regionMatchCount != null}"
                              th:text="'📍선택지역 ' + ${post.regionMatchCount} + '개 포함'"></span>

                        <span class="badge"
                              th:if="${post.travelType != null}"
                              th:text="${post.travelType == 'solo' ? '혼자' :
                                       post.travelType == 'couple' ? '커플' :
                                       post.travelType == 'family' ? '가족' :
                                       post.travelType == 'friends' ? '친구' :
                                       post.travelType}">유형</span>

                        <span class="badge"
                              th:if="${post.theme != null}"
                              th:text="${post.theme == 'freedom' ? '자유여행' :
                                       post.theme == 'healing' ? '힐링' :
                                       post.theme == 'food' ? '맛집' :
                                       post.theme == 'activity' ? '액티비티' :
                                       post.theme == 'nature' ? '자연' :
                                       post.theme}">테마</span>

                        <span class="badge"
                              th:if="${post.period != null}"
                              th:text="${post.period}">기간</span>

                        <span class="badge"
                              th:if="${post.level != null}"
                              th:text="${post.level}">난이도</span>

                        <span class="badge"
                              th:each="tag : ${post.regionTags}"
                              th:text="${tag}">지역</span>

                        <span class="badge total"
                              th:text="|총액: ${#numbers.formatInteger(
                                    (post.budgetFlight  ?: 0)
                                  + (post.budgetLodging ?: 0)
                                  + (post.budgetFood   ?: 0)
                                  + (post.budgetExtra  ?: 0)
                                  , 0, 'COMMA')}만|">
                        </span>
                    </div>

                    <p class="post-desc" th:text="${#strings.abbreviate(post.summary, 80)}">요약</p>
                </div>
            </a>
        </article>

        <div class="empty" th:if="${posts == null || #lists.isEmpty(posts)}">
            조건에 맞는 게시글이 없습니다.
        </div>
    </section>


    <!-- =========================
         Pagination (BOTTOM)
    ========================== -->
    <div class="reviews-pagination bottom"
         th:if="${pageResult != null and pageResult.totalPages > 1}"
         th:with="
            current=${pageResult.number},
            total=${pageResult.totalPages},
            blockSize=${10},
            blockStart=${(current / blockSize) * blockSize},
            blockEnd=${(blockStart + blockSize - 1) < (total - 1) ? (blockStart + blockSize - 1) : (total - 1)},
            minB=${(search != null and search.minBudget != null) ? search.minBudget : 0},
            maxB=${(search != null and search.maxBudget != null) ? search.maxBudget : 5000000},
            unlimit=${param.budgetUnlimit}
         ">

        <!-- «« first -->
        <a class="reviews-page-btn"
           th:if="${current > 0 and !isUnity}"
           th:href="@{/reviews(
                page=0,
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&laquo;&laquo;</a>

        <a class="reviews-page-btn"
           th:if="${current > 0 and isUnity}"
           th:href="@{/reviews-unity(
                page=0,
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&laquo;&laquo;</a>

        <span class="reviews-page-btn disabled" th:if="${current == 0}">&laquo;&laquo;</span>

        <!-- « prev block -->
        <a class="reviews-page-btn"
           th:if="${blockStart > 0 and !isUnity}"
           th:href="@{/reviews(
                page=${blockStart - 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&laquo;</a>

        <a class="reviews-page-btn"
           th:if="${blockStart > 0 and isUnity}"
           th:href="@{/reviews-unity(
                page=${blockStart - 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&laquo;</a>

        <span class="reviews-page-btn disabled" th:if="${blockStart == 0}">&laquo;</span>

        <!-- numbers -->
        <span class="reviews-page-numbers">
            <span th:each="p : ${#numbers.sequence(blockStart, blockEnd)}">

                <span class="reviews-page-btn active"
                      th:if="${p == current}"
                      th:text="${p + 1}">1</span>

                <a class="reviews-page-btn"
                   th:if="${p != current and !isUnity}"
                   th:text="${p + 1}"
                   th:href="@{/reviews(
                        page=${p},
                        q=${search.q},
                        travelType=${search.travelType},
                        theme=${search.theme},
                        minBudget=${minB},
                        maxBudget=${maxB},
                        periods=${search.periods},
                        levels=${search.levels},
                        tags=${search.tags},
                        budgetUnlimit=${unlimit}
                   )} + '#postList'">1</a>

                <a class="reviews-page-btn"
                   th:if="${p != current and isUnity}"
                   th:text="${p + 1}"
                   th:href="@{/reviews-unity(
                        page=${p},
                        q=${search.q},
                        travelType=${search.travelType},
                        theme=${search.theme},
                        minBudget=${minB},
                        maxBudget=${maxB},
                        periods=${search.periods},
                        levels=${search.levels},
                        tags=${search.tags},
                        budgetUnlimit=${unlimit}
                   )} + '#postList'">1</a>

            </span>
        </span>

        <!-- next block » -->
        <a class="reviews-page-btn"
           th:if="${blockEnd < (total - 1) and !isUnity}"
           th:href="@{/reviews(
                page=${blockEnd + 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&raquo;</a>

        <a class="reviews-page-btn"
           th:if="${blockEnd < (total - 1) and isUnity}"
           th:href="@{/reviews-unity(
                page=${blockEnd + 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&raquo;</a>

        <span class="reviews-page-btn disabled" th:if="${blockEnd >= (total - 1)}">&raquo;</span>

        <!-- last »» -->
        <a class="reviews-page-btn"
           th:if="${current < (total - 1) and !isUnity}"
           th:href="@{/reviews(
                page=${total - 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&raquo;&raquo;</a>

        <a class="reviews-page-btn"
           th:if="${current < (total - 1) and isUnity}"
           th:href="@{/reviews-unity(
                page=${total - 1},
                q=${search.q},
                travelType=${search.travelType},
                theme=${search.theme},
                minBudget=${minB},
                maxBudget=${maxB},
                periods=${search.periods},
                levels=${search.levels},
                tags=${search.tags},
                budgetUnlimit=${unlimit}
           )} + '#postList'">&raquo;&raquo;</a>

        <span class="reviews-page-btn disabled" th:if="${current >= (total - 1)}">&raquo;&raquo;</span>

    </div>

</div>
